/// <reference path="../../../typings/tsd.d.ts" />
/// <reference path="../connection/connection.service.ts" />
var Q = require("q");
var connection = require('../connection/connection.service');
var AuthService = (function () {
    function AuthService() {
        this.db = connection.service;
    }
    AuthService.prototype.getNonce = function (controller, method) {
        return this.db.query('core/get_nonce/?controller=' + controller + '&method=' + method);
    };
    AuthService.prototype.register = function (username, email, password, display_name, years, country, school, ob) {
        var _this = this;
        var _promisesList = [];
        var registerPromise = Q.defer();
        this.getNonce('user', 'register').then(function (nonce) {
            _this.db.query('user/register/?username=' + username + '&email=' + email + '&password=' + password + '&nonce=' + nonce['nonce'] + '&notify=yes' + '&user_registered=yes' + '&display_name=' + display_name).then(function (results) {
                var i = [0, 1, 2, 3, 4];
                var fieldIds = [1, 645, 2, 4, 646];
                var fieldValues = [display_name, years, country, school, ob];
                if (results['status'] == 'error') {
                    registerPromise.resolve(results);
                    return registerPromise.promise;
                }
                else {
                    var userId = results['user_id'];
                    i.forEach(function (id) {
                        var xProfilePromise = Q.defer();
                        _promisesList.push(xProfilePromise.promise);
                        // if years value
                        if (fieldIds[id] == 645) {
                            // number value
                            var xProfileQuery = "INSERT INTO wp2_bp_xprofile_data (id, field_id, user_id, value, last_updated) " + "VALUES (null," + fieldIds[id] + "," + userId + "," + fieldValues[id] + ",'" + new Date().toISOString() + "')";
                        }
                        else {
                            // string value
                            var xProfileQuery = "INSERT INTO wp2_bp_xprofile_data (id, field_id, user_id, value, last_updated) " + "VALUES (null," + fieldIds[id] + "," + userId + ",'" + fieldValues[id] + "','" + new Date().toISOString() + "')";
                        }
                        ;
                        _this.db.query_db(xProfileQuery).then(function (data) {
                            xProfilePromise.resolve(data);
                        });
                    });
                    Q.all(_promisesList).then(function (values) {
                        results['username'] = username;
                        results['email'] = email;
                        results['display_name'] = display_name;
                        results['years'] = years;
                        results['country'] = country;
                        results['school'] = school;
                        results['ob'] = ob;
                        registerPromise.resolve(results);
                    });
                }
                ;
            });
        });
        return registerPromise.promise;
    };
    AuthService.prototype.login = function (username, password) {
        return this.db.query('user/generate_auth_cookie/?username=' + username + '&password=' + password);
    };
    AuthService.prototype.fbLogin = function (token) {
        return this.db.query('user/fb_connect/?access_token=' + token);
    };
    AuthService.prototype.isAuthorized = function (cookie) {
        return this.db.query('user/validate_auth_cookie/?cookie=' + cookie);
    };
    AuthService.prototype.getUserInfo = function (userId) {
        return this.db.query('user/get_userinfo/?user_id=' + userId);
    };
    AuthService.prototype.getUserAvatar = function (userId, type) {
        return this.db.query('user/get_avatar/?user_id=' + userId + '&type=' + type);
    };
    AuthService.prototype.resetPassword = function (username) {
        return this.db.query('user/retrieve_password/?user_login=' + username);
    };
    return AuthService;
})();
exports.AuthService = AuthService;
;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZHVsZXMvYXV0aC9hdXRoLnNlcnZpY2UudHMiXSwibmFtZXMiOlsiQXV0aFNlcnZpY2UiLCJBdXRoU2VydmljZS5jb25zdHJ1Y3RvciIsIkF1dGhTZXJ2aWNlLmdldE5vbmNlIiwiQXV0aFNlcnZpY2UucmVnaXN0ZXIiLCJBdXRoU2VydmljZS5sb2dpbiIsIkF1dGhTZXJ2aWNlLmZiTG9naW4iLCJBdXRoU2VydmljZS5pc0F1dGhvcml6ZWQiLCJBdXRoU2VydmljZS5nZXRVc2VySW5mbyIsIkF1dGhTZXJ2aWNlLmdldFVzZXJBdmF0YXIiLCJBdXRoU2VydmljZS5yZXNldFBhc3N3b3JkIl0sIm1hcHBpbmdzIjoiQUFBQSxrREFBa0Q7QUFDbEQsNERBQTREO0FBRTVELElBQU8sQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDO0FBQ3hCLElBQU8sVUFBVSxXQUFXLGtDQUFrQyxDQUFDLENBQUM7QUFlaEUsSUFBYSxXQUFXO0lBQXhCQSxTQUFhQSxXQUFXQTtRQUNaQyxPQUFFQSxHQUFHQSxVQUFVQSxDQUFDQSxPQUFPQSxDQUFDQTtJQThGcENBLENBQUNBO0lBNUZHRCw4QkFBUUEsR0FBUkEsVUFBU0EsVUFBVUEsRUFBRUEsTUFBTUE7UUFDdkJFLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLEtBQUtBLENBQUNBLDZCQUE2QkEsR0FBR0EsVUFBVUEsR0FDMUNBLFVBQVVBLEdBQUdBLE1BQU1BLENBQUNBLENBQUFBO0lBQzdDQSxDQUFDQTtJQUVERiw4QkFBUUEsR0FBUkEsVUFBU0EsUUFBUUEsRUFBRUEsS0FBS0EsRUFBRUEsUUFBUUEsRUFBRUEsWUFBWUEsRUFBRUEsS0FBS0EsRUFBRUEsT0FBT0EsRUFBRUEsTUFBTUEsRUFBRUEsRUFBRUE7UUFBNUVHLGlCQTREQ0E7UUEzREdBLElBQUlBLGFBQWFBLEdBQUdBLEVBQUVBLENBQUNBO1FBQ3ZCQSxJQUFJQSxlQUFlQSxHQUFHQSxDQUFDQSxDQUFDQSxLQUFLQSxFQUFFQSxDQUFDQTtRQUNo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Q0EsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsZ0NBQWdDQSxHQUFHQSxLQUFLQSxDQUFDQSxDQUFBQTtJQUNsRUEsQ0FBQ0E7SUFFREwsa0NBQVlBLEdBQVpBLFVBQWFBLE1BQU1BO1FBQ2ZNLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLEtBQUtBLENBQUNBLG9DQUFvQ0EsR0FBR0EsTUFBTUEsQ0FBQ0EsQ0FBQUE7SUFDdkVBLENBQUNBO0lBRUROLGlDQUFXQSxHQUFYQSxVQUFZQSxNQUFNQTtRQUNkTyxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxLQUFLQSxDQUFDQSw2QkFBNkJBLEdBQUdBLE1BQU1BLENBQUNBLENBQUFBO0lBQ2hFQSxDQUFDQTtJQUVEUCxtQ0FBYUEsR0FBYkEsVUFBY0EsTUFBTUEsRUFBRUEsSUFBSUE7UUFDdEJRLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLEtBQUtBLENBQUNBLDJCQUEyQkEsR0FBR0EsTUFBTUEsR0FDcENBLFFBQVFBLEdBQUdBLElBQUlBLENBQUNBLENBQUFBO0lBQ3pDQSxDQUFDQTtJQUVEUixtQ0FBYUEsR0FBYkEsVUFBY0EsUUFBUUE7UUFDbEJTLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLEtBQUtBLENBQUNBLHFDQUFxQ0EsR0FBR0EsUUFBUUEsQ0FBQ0EsQ0FBQUE7SUFDMUVBLENBQUNBO0lBQ0xULGtCQUFDQTtBQUFEQSxDQS9GQSxBQStGQ0EsSUFBQTtBQS9GWSxtQkFBVyxHQUFYLFdBK0ZaLENBQUE7QUFBQSxDQUFDIiwiZmlsZSI6Im1vZHVsZXMvYXV0aC9hdXRoLnNlcnZpY2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vLi4vLi4vdHlwaW5ncy90c2QuZC50c1wiIC8+XG4vLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vY29ubmVjdGlvbi9jb25uZWN0aW9uLnNlcnZpY2UudHNcIiAvPlxuXG5pbXBvcnQgUSA9IHJlcXVpcmUoXCJxXCIpO1xuaW1wb3J0IGNvbm5lY3Rpb24gPSByZXF1aXJlKCcuLi9jb25uZWN0aW9uL2Nvbm5lY3Rpb24uc2VydmljZScpO1xuXG5leHBvcnQgaW50ZXJmYWNlIElBdXRoU2VydmljZSB7XG4gICAgLy8gR0VUXG4gICAgZ2V0Tm9uY2UoY29udHJvbGxlciwgbWV0aG9kKTogUS5JUHJvbWlzZTx7fT47XG4gICAgZ2V0VXNlckluZm8odXNlcklkKTogUS5JUHJvbWlzZTx7fT47XG4gICAgZ2V0VXNlckF2YXRhcih1c2VySWQsIHR5cGUpOiBRLklQcm9taXNlPHt9PjtcbiAgICAvLyBQT1NUXG4gICAgcmVnaXN0ZXIodXNlcm5hbWUsIGVtYWlsLCBwYXNzd29yZCwgZGlzcGxheV9uYW1lLCB5ZWFycywgY291bnRyeSwgc2Nob29sLCBvYik6IFEuSVByb21pc2U8e30+O1xuICAgIGxvZ2luKHVzZXJuYW1lLCBwYXNzd29yZCk6IFEuSVByb21pc2U8e30+O1xuICAgIGZiTG9naW4odG9rZW4pOiBRLklQcm9taXNlPHt9PjtcbiAgICBpc0F1dGhvcml6ZWQoY29va2llKTogUS5JUHJvbWlzZTx7fT47XG4gICAgcmVzZXRQYXNzd29yZCh1c2VybmFtZSk6IFEuSVByb21pc2U8e30+O1xufVxuXG5leHBvcnQgY2xhc3MgQXV0aFNlcnZpY2UgaW1wbGVtZW50cyBJQXV0aFNlcnZpY2Uge1xuICAgIHByaXZhdGUgZGIgPSBjb25uZWN0aW9uLnNlcnZpY2U7XG5cbiAgICBnZXROb25jZShjb250cm9sbGVyLCBtZXRob2QpOiBRLklQcm9taXNlPHt9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmRiLnF1ZXJ5KCdjb3JlL2dldF9ub25jZS8/Y29udHJvbGxlcj0nICsgY29udHJvbGxlciArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICcmbWV0aG9kPScgKyBtZXRob2QpXG4gICAgfVxuXG4gICAgcmVnaXN0ZXIodXNlcm5hbWUsIGVtYWlsLCBwYXNzd29yZCwgZGlzcGxheV9uYW1lLCB5ZWFycywgY291bnRyeSwgc2Nob29sLCBvYik6IFEuSVByb21pc2U8e30+IHtcbiAgICAgICAgdmFyIF9wcm9taXNlc0xpc3QgPSBbXTtcbiAgICAgICAgdmFyIHJlZ2lzdGVyUHJvbWlzZSA9IFEuZGVmZXIoKTtcbiAgICAgICAgdGhpcy5nZXROb25jZSgndXNlcicsICdyZWdpc3RlcicpXG4gICAgICAgICAgICAudGhlbigobm9uY2UpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmRiLnF1ZXJ5KCd1c2VyL3JlZ2lzdGVyLz91c2VybmFtZT0nICsgdXNlcm5hbWUgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcmZW1haWw9JyArIGVtYWlsICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnJnBhc3N3b3JkPScgKyBwYXNzd29yZCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyZub25jZT0nICsgbm9uY2VbJ25vbmNlJ10gK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcmbm90aWZ5PXllcycgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcmdXNlcl9yZWdpc3RlcmVkPXllcycgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcmZGlzcGxheV9uYW1lPScgKyBkaXNwbGF5X25hbWUpXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKChyZXN1bHRzKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgaSA9IFswLCAxLCAyLCAzLCA0XTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBmaWVsZElkcyA9IFsxLCA2NDUsIDIsIDQsIDY0Nl07XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZmllbGRWYWx1ZXMgPSBbZGlzcGxheV9uYW1lLCB5ZWFycywgY291bnRyeSwgc2Nob29sLCBvYl07XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHRzWydzdGF0dXMnXSA9PSAnZXJyb3InKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVnaXN0ZXJQcm9taXNlLnJlc29sdmUocmVzdWx0cyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlZ2lzdGVyUHJvbWlzZS5wcm9taXNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdXNlcklkID0gcmVzdWx0c1sndXNlcl9pZCddO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaS5mb3JFYWNoKChpZCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgeFByb2ZpbGVQcm9taXNlID0gUS5kZWZlcigpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9wcm9taXNlc0xpc3QucHVzaCh4UHJvZmlsZVByb21pc2UucHJvbWlzZSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgeWVhcnMgdmFsdWVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpZWxkSWRzW2lkXSA9PSA2NDUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG51bWJlciB2YWx1ZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHhQcm9maWxlUXVlcnkgPSBcIklOU0VSVCBJTlRPIHdwMl9icF94cHJvZmlsZV9kYXRhIChpZCwgZmllbGRfaWQsIHVzZXJfaWQsIHZhbHVlLCBsYXN0X3VwZGF0ZWQpIFwiICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIlZBTFVFUyAobnVsbCxcIiArIGZpZWxkSWRzW2lkXSArIFwiLFwiICsgdXNlcklkICsgXCIsXCIgKyBmaWVsZFZhbHVlc1tpZF0gKyBcIiwnXCIgKyBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkgKyBcIicpXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzdHJpbmcgdmFsdWVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB4UHJvZmlsZVF1ZXJ5ID0gXCJJTlNFUlQgSU5UTyB3cDJfYnBfeHByb2ZpbGVfZGF0YSAoaWQsIGZpZWxkX2lkLCB1c2VyX2lkLCB2YWx1ZSwgbGFzdF91cGRhdGVkKSBcIiArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJWQUxVRVMgKG51bGwsXCIgKyBmaWVsZElkc1tpZF0gKyBcIixcIiArIHVzZXJJZCArIFwiLCdcIiArIGZpZWxkVmFsdWVzW2lkXSArIFwiJywnXCIgKyBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkgKyBcIicpXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kYi5xdWVyeV9kYih4UHJvZmlsZVF1ZXJ5KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oKGRhdGEpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4UHJvZmlsZVByb21pc2UucmVzb2x2ZShkYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBRLmFsbChfcHJvbWlzZXNMaXN0KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbigodmFsdWVzKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzWyd1c2VybmFtZSddID0gdXNlcm5hbWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzWydlbWFpbCddID0gZW1haWw7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzWydkaXNwbGF5X25hbWUnXSA9IGRpc3BsYXlfbmFtZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHNbJ3llYXJzJ10gPSB5ZWFycztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHNbJ2NvdW50cnknXSA9IGNvdW50cnk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzWydzY2hvb2wnXSA9IHNjaG9vbDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHNbJ29iJ10gPSBvYjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZ2lzdGVyUHJvbWlzZS5yZXNvbHZlKHJlc3VsdHMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHJlZ2lzdGVyUHJvbWlzZS5wcm9taXNlO1xuICAgIH1cblxuICAgIGxvZ2luKHVzZXJuYW1lLCBwYXNzd29yZCk6IFEuSVByb21pc2U8e30+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIucXVlcnkoJ3VzZXIvZ2VuZXJhdGVfYXV0aF9jb29raWUvP3VzZXJuYW1lPScgKyB1c2VybmFtZSArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICcmcGFzc3dvcmQ9JyArIHBhc3N3b3JkKVxuICAgIH1cblxuICAgIGZiTG9naW4odG9rZW4pOiBRLklQcm9taXNlPHt9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmRiLnF1ZXJ5KCd1c2VyL2ZiX2Nvbm5lY3QvP2FjY2Vzc190b2tlbj0nICsgdG9rZW4pXG4gICAgfVxuXG4gICAgaXNBdXRob3JpemVkKGNvb2tpZSk6IFEuSVByb21pc2U8e30+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIucXVlcnkoJ3VzZXIvdmFsaWRhdGVfYXV0aF9jb29raWUvP2Nvb2tpZT0nICsgY29va2llKVxuICAgIH1cblxuICAgIGdldFVzZXJJbmZvKHVzZXJJZCk6IFEuSVByb21pc2U8e30+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIucXVlcnkoJ3VzZXIvZ2V0X3VzZXJpbmZvLz91c2VyX2lkPScgKyB1c2VySWQpXG4gICAgfVxuXG4gICAgZ2V0VXNlckF2YXRhcih1c2VySWQsIHR5cGUpOiBRLklQcm9taXNlPHt9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmRiLnF1ZXJ5KCd1c2VyL2dldF9hdmF0YXIvP3VzZXJfaWQ9JyArIHVzZXJJZCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICcmdHlwZT0nICsgdHlwZSlcbiAgICB9XG5cbiAgICByZXNldFBhc3N3b3JkKHVzZXJuYW1lKTogUS5JUHJvbWlzZTx7fT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5kYi5xdWVyeSgndXNlci9yZXRyaWV2ZV9wYXNzd29yZC8/dXNlcl9sb2dpbj0nICsgdXNlcm5hbWUpXG4gICAgfVxufTtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==