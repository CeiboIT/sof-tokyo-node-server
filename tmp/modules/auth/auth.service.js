/// <reference path="../../../typings/tsd.d.ts" />
/// <reference path="../connection/connection.service.ts" />
var Q = require("q");
var connection = require('../connection/connection.service');
var UserAvatar = (function () {
    function UserAvatar(avatarUrl) {
        this._avatar = avatarUrl;
    }
    Object.defineProperty(UserAvatar.prototype, "avatar", {
        get: function () {
            return this._avatar;
        },
        enumerable: true,
        configurable: true
    });
    return UserAvatar;
})();
exports.UserAvatar = UserAvatar;
var AuthService = (function () {
    function AuthService() {
        this.db = connection.service;
    }
    AuthService.prototype.getNonce = function (controller, method) {
        return this.db.query('core/get_nonce/?controller=' + controller + '&method=' + method);
    };
    AuthService.prototype.register = function (username, email, password, display_name, years, country, school, ob) {
        var _this = this;
        var _promisesList = [];
        var registerPromise = Q.defer();
        this.getNonce('user', 'register').then(function (nonce) {
            _this.db.query('user/register/?username=' + username + '&email=' + email + '&password=' + password + '&nonce=' + nonce['nonce'] + '&notify=yes' + '&user_registered=yes' + '&display_name=' + display_name).then(function (results) {
                var i = [0, 1, 2, 3, 4];
                var fieldIds = [1, 645, 2, 4, 646];
                var fieldValues = [display_name, years, country, school, ob];
                if (results['status'] == 'error') {
                    if (results['error'] == "E-mail address is already in use.") {
                        results['code'] = '000';
                    }
                    ;
                    if (results['error'] == "Username already exists.") {
                        results['code'] = '001';
                    }
                    ;
                    registerPromise.resolve(results);
                    return registerPromise.promise;
                }
                else {
                    var userId = results['user_id'];
                    i.forEach(function (id) {
                        var xProfilePromise = Q.defer();
                        _promisesList.push(xProfilePromise.promise);
                        // if years value
                        if (fieldIds[id] == 645) {
                            // number value
                            var xProfileQuery = "INSERT INTO wp2_bp_xprofile_data (id, field_id, user_id, value, last_updated) " + "VALUES (null," + fieldIds[id] + "," + userId + "," + fieldValues[id] + ",'" + new Date().toISOString() + "')";
                        }
                        else {
                            // string value
                            var xProfileQuery = "INSERT INTO wp2_bp_xprofile_data (id, field_id, user_id, value, last_updated) " + "VALUES (null," + fieldIds[id] + "," + userId + ",'" + fieldValues[id] + "','" + new Date().toISOString() + "')";
                        }
                        ;
                        _this.db.query_db(xProfileQuery).then(function (data) {
                            xProfilePromise.resolve(data);
                        });
                    });
                    Q.all(_promisesList).then(function (values) {
                        results['username'] = username;
                        results['email'] = email;
                        results['display_name'] = display_name;
                        results['years'] = years;
                        results['country'] = country;
                        results['school'] = school;
                        results['ob'] = ob;
                        registerPromise.resolve(results);
                    });
                }
                ;
            });
        });
        return registerPromise.promise;
    };
    AuthService.prototype.login = function (username, password) {
        var loginPromise = Q.defer();
        this.db.query('user/generate_auth_cookie/?username=' + username + '&password=' + password).then(function (results) {
            if (results['status'] == 'error') {
                if (results['error'] == "Invalid username and/or password.") {
                    results['code'] = '100';
                }
                ;
            }
            ;
            loginPromise.resolve(results);
        });
        return loginPromise.promise;
    };
    AuthService.prototype.fbLogin = function (token) {
        return this.db.query('user/fb_connect/?access_token=' + token);
    };
    AuthService.prototype.isAuthorized = function (cookie) {
        return this.db.query('user/validate_auth_cookie/?cookie=' + cookie);
    };
    AuthService.prototype.getUserInfo = function (userId) {
        return this.db.query('user/get_userinfo/?user_id=' + userId);
    };
    AuthService.prototype.getUserAvatarUrl = function (userId) {
        var deferred = Q.defer();
        var query = "SELECT meta_value FROM wp2_usermeta WHERE user_id=" + userId + " AND meta_key='kleo_fb_picture' ";
        try {
            this.db.query_db(query).then(function (response) {
                console.log('getUserAvatarUrl response ', JSON.stringify(response));
                if (response.length > 0) {
                    deferred.resolve(new UserAvatar(response[0].meta_value));
                }
                else {
                    deferred.resolve(new UserAvatar(''));
                }
            });
        }
        catch (error) {
            console.error('getUserAvatarUrl error ', error);
        }
        return deferred.promise;
    };
    AuthService.prototype.getUserAvatar = function (userId, type) {
        return this.db.query('user/get_avatar/?user_id=' + userId + '&type=' + type);
    };
    AuthService.prototype.resetPassword = function (username) {
        return this.db.query('user/retrieve_password/?user_login=' + username);
    };
    return AuthService;
})();
exports.AuthService = AuthService;
;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZHVsZXMvYXV0aC9hdXRoLnNlcnZpY2UudHMiXSwibmFtZXMiOlsiVXNlckF2YXRhciIsIlVzZXJBdmF0YXIuY29uc3RydWN0b3IiLCJVc2VyQXZhdGFyLmF2YXRhciIsIkF1dGhTZXJ2aWNlIiwiQXV0aFNlcnZpY2UuY29uc3RydWN0b3IiLCJBdXRoU2VydmljZS5nZXROb25jZSIsIkF1dGhTZXJ2aWNlLnJlZ2lzdGVyIiwiQXV0aFNlcnZpY2UubG9naW4iLCJBdXRoU2VydmljZS5mYkxvZ2luIiwiQXV0aFNlcnZpY2UuaXNBdXRob3JpemVkIiwiQXV0aFNlcnZpY2UuZ2V0VXNlckluZm8iLCJBdXRoU2VydmljZS5nZXRVc2VyQXZhdGFyVXJsIiwiQXV0aFNlcnZpY2UuZ2V0VXNlckF2YXRhciIsIkF1dGhTZXJ2aWNlLnJlc2V0UGFzc3dvcmQiXSwibWFwcGluZ3MiOiJBQUFBLGtEQUFrRDtBQUNsRCw0REFBNEQ7QUFFNUQsSUFBTyxDQUFDLFdBQVcsR0FBRyxDQUFDLENBQUM7QUFDeEIsSUFBTyxVQUFVLFdBQVcsa0NBQWtDLENBQUMsQ0FBQztBQUVoRSxJQUFhLFVBQVU7SUFHbkJBLFNBSFNBLFVBQVVBLENBR05BLFNBQWlCQTtRQUMxQkMsSUFBSUEsQ0FBQ0EsT0FBT0EsR0FBR0EsU0FBU0EsQ0FBQ0E7SUFDN0JBLENBQUNBO0lBRURELHNCQUFJQSw4QkFBTUE7YUFBVkE7WUFDSUUsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0E7UUFDeEJBLENBQUNBOzs7T0FBQUY7SUFDTEEsaUJBQUNBO0FBQURBLENBVkEsQUFVQ0EsSUFBQTtBQVZZLGtCQUFVLEdBQVYsVUFVWixDQUFBO0FBaUJELElBQWEsV0FBVztJQUF4QkcsU0FBYUEsV0FBV0E7UUFDWkMsT0FBRUEsR0FBR0EsVUFBVUEsQ0FBQ0EsT0FBT0EsQ0FBQ0E7SUFrSXBDQSxDQUFDQTtJQWhJR0QsOEJBQVFBLEdBQVJBLFVBQVNBLFVBQVVBLEVBQUVBLE1BQU1BO1FBQ3ZCRSxN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bW9kdWxlcy9hdXRoL2F1dGguc2VydmljZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi8uLi90eXBpbmdzL3RzZC5kLnRzXCIgLz5cbi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi9jb25uZWN0aW9uL2Nvbm5lY3Rpb24uc2VydmljZS50c1wiIC8+XG5cbmltcG9ydCBRID0gcmVxdWlyZShcInFcIik7XG5pbXBvcnQgY29ubmVjdGlvbiA9IHJlcXVpcmUoJy4uL2Nvbm5lY3Rpb24vY29ubmVjdGlvbi5zZXJ2aWNlJyk7XG5cbmV4cG9ydCBjbGFzcyBVc2VyQXZhdGFyIHtcbiAgICBwcml2YXRlIF9hdmF0YXI6IHN0cmluZztcbiAgICBcbiAgICBjb25zdHJ1Y3RvciAoYXZhdGFyVXJsOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5fYXZhdGFyID0gYXZhdGFyVXJsO1xuICAgIH1cblxuICAgIGdldCBhdmF0YXIoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2F2YXRhcjtcbiAgICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUF1dGhTZXJ2aWNlIHtcbiAgICAvLyBHRVRcbiAgICBnZXROb25jZShjb250cm9sbGVyLCBtZXRob2QpOiBRLklQcm9taXNlPHt9PjtcbiAgICBnZXRVc2VySW5mbyh1c2VySWQpOiBRLklQcm9taXNlPHt9PjtcbiAgICBnZXRVc2VyQXZhdGFyKHVzZXJJZCwgdHlwZSk6IFEuSVByb21pc2U8e30+O1xuICAgIGdldFVzZXJBdmF0YXJVcmwodXNlcklkKTogUS5JUHJvbWlzZTxVc2VyQXZhdGFyPjtcbiAgICBcbiAgICAvLyBQT1NUXG4gICAgcmVnaXN0ZXIodXNlcm5hbWUsIGVtYWlsLCBwYXNzd29yZCwgZGlzcGxheV9uYW1lLCB5ZWFycywgY291bnRyeSwgc2Nob29sLCBvYik6IFEuSVByb21pc2U8e30+O1xuICAgIGxvZ2luKHVzZXJuYW1lLCBwYXNzd29yZCk6IFEuSVByb21pc2U8e30+O1xuICAgIGZiTG9naW4odG9rZW4pOiBRLklQcm9taXNlPHt9PjtcbiAgICBpc0F1dGhvcml6ZWQoY29va2llKTogUS5JUHJvbWlzZTx7fT47XG4gICAgcmVzZXRQYXNzd29yZCh1c2VybmFtZSk6IFEuSVByb21pc2U8e30+O1xufVxuXG5leHBvcnQgY2xhc3MgQXV0aFNlcnZpY2UgaW1wbGVtZW50cyBJQXV0aFNlcnZpY2Uge1xuICAgIHByaXZhdGUgZGIgPSBjb25uZWN0aW9uLnNlcnZpY2U7XG5cbiAgICBnZXROb25jZShjb250cm9sbGVyLCBtZXRob2QpOiBRLklQcm9taXNlPHt9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmRiLnF1ZXJ5KCdjb3JlL2dldF9ub25jZS8/Y29udHJvbGxlcj0nICsgY29udHJvbGxlciArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICcmbWV0aG9kPScgKyBtZXRob2QpXG4gICAgfVxuXG4gICAgcmVnaXN0ZXIodXNlcm5hbWUsIGVtYWlsLCBwYXNzd29yZCwgZGlzcGxheV9uYW1lLCB5ZWFycywgY291bnRyeSwgc2Nob29sLCBvYik6IFEuSVByb21pc2U8e30+IHtcbiAgICAgICAgdmFyIF9wcm9taXNlc0xpc3QgPSBbXTtcbiAgICAgICAgdmFyIHJlZ2lzdGVyUHJvbWlzZSA9IFEuZGVmZXIoKTtcbiAgICAgICAgdGhpcy5nZXROb25jZSgndXNlcicsICdyZWdpc3RlcicpXG4gICAgICAgICAgICAudGhlbigobm9uY2UpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmRiLnF1ZXJ5KCd1c2VyL3JlZ2lzdGVyLz91c2VybmFtZT0nICsgdXNlcm5hbWUgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcmZW1haWw9JyArIGVtYWlsICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnJnBhc3N3b3JkPScgKyBwYXNzd29yZCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyZub25jZT0nICsgbm9uY2VbJ25vbmNlJ10gK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcmbm90aWZ5PXllcycgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcmdXNlcl9yZWdpc3RlcmVkPXllcycgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcmZGlzcGxheV9uYW1lPScgKyBkaXNwbGF5X25hbWUpXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKChyZXN1bHRzKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgaSA9IFswLCAxLCAyLCAzLCA0XTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBmaWVsZElkcyA9IFsxLCA2NDUsIDIsIDQsIDY0Nl07XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZmllbGRWYWx1ZXMgPSBbZGlzcGxheV9uYW1lLCB5ZWFycywgY291bnRyeSwgc2Nob29sLCBvYl07XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHRzWydzdGF0dXMnXSA9PSAnZXJyb3InKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYocmVzdWx0c1snZXJyb3InXSA9PSBcIkUtbWFpbCBhZGRyZXNzIGlzIGFscmVhZHkgaW4gdXNlLlwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHNbJ2NvZGUnXSA9ICcwMDAnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYocmVzdWx0c1snZXJyb3InXSA9PSBcIlVzZXJuYW1lIGFscmVhZHkgZXhpc3RzLlwiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHNbJ2NvZGUnXSA9ICcwMDEnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVnaXN0ZXJQcm9taXNlLnJlc29sdmUocmVzdWx0cyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlZ2lzdGVyUHJvbWlzZS5wcm9taXNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdXNlcklkID0gcmVzdWx0c1sndXNlcl9pZCddO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaS5mb3JFYWNoKChpZCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgeFByb2ZpbGVQcm9taXNlID0gUS5kZWZlcigpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9wcm9taXNlc0xpc3QucHVzaCh4UHJvZmlsZVByb21pc2UucHJvbWlzZSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgeWVhcnMgdmFsdWVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpZWxkSWRzW2lkXSA9PSA2NDUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIG51bWJlciB2YWx1ZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHhQcm9maWxlUXVlcnkgPSBcIklOU0VSVCBJTlRPIHdwMl9icF94cHJvZmlsZV9kYXRhIChpZCwgZmllbGRfaWQsIHVzZXJfaWQsIHZhbHVlLCBsYXN0X3VwZGF0ZWQpIFwiICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIlZBTFVFUyAobnVsbCxcIiArIGZpZWxkSWRzW2lkXSArIFwiLFwiICsgdXNlcklkICsgXCIsXCIgKyBmaWVsZFZhbHVlc1tpZF0gKyBcIiwnXCIgKyBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkgKyBcIicpXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBzdHJpbmcgdmFsdWVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB4UHJvZmlsZVF1ZXJ5ID0gXCJJTlNFUlQgSU5UTyB3cDJfYnBfeHByb2ZpbGVfZGF0YSAoaWQsIGZpZWxkX2lkLCB1c2VyX2lkLCB2YWx1ZSwgbGFzdF91cGRhdGVkKSBcIiArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJWQUxVRVMgKG51bGwsXCIgKyBmaWVsZElkc1tpZF0gKyBcIixcIiArIHVzZXJJZCArIFwiLCdcIiArIGZpZWxkVmFsdWVzW2lkXSArIFwiJywnXCIgKyBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkgKyBcIicpXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kYi5xdWVyeV9kYih4UHJvZmlsZVF1ZXJ5KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oKGRhdGEpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4UHJvZmlsZVByb21pc2UucmVzb2x2ZShkYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBRLmFsbChfcHJvbWlzZXNMaXN0KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbigodmFsdWVzKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzWyd1c2VybmFtZSddID0gdXNlcm5hbWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzWydlbWFpbCddID0gZW1haWw7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzWydkaXNwbGF5X25hbWUnXSA9IGRpc3BsYXlfbmFtZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHNbJ3llYXJzJ10gPSB5ZWFycztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHNbJ2NvdW50cnknXSA9IGNvdW50cnk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzWydzY2hvb2wnXSA9IHNjaG9vbDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHNbJ29iJ10gPSBvYjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZ2lzdGVyUHJvbWlzZS5yZXNvbHZlKHJlc3VsdHMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHJlZ2lzdGVyUHJvbWlzZS5wcm9taXNlO1xuICAgIH1cblxuICAgIGxvZ2luKHVzZXJuYW1lLCBwYXNzd29yZCk6IFEuSVByb21pc2U8e30+IHtcbiAgICAgICAgdmFyIGxvZ2luUHJvbWlzZSA9IFEuZGVmZXIoKTtcbiAgICAgICAgdGhpcy5kYi5xdWVyeSgndXNlci9nZW5lcmF0ZV9hdXRoX2Nvb2tpZS8/dXNlcm5hbWU9JyArIHVzZXJuYW1lICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyZwYXNzd29yZD0nICsgcGFzc3dvcmQpXG4gICAgICAgIC50aGVuKChyZXN1bHRzKSA9PiB7XG4gICAgICAgICAgICBpZiAocmVzdWx0c1snc3RhdHVzJ10gPT0gJ2Vycm9yJykge1xuICAgICAgICAgICAgICAgIGlmKHJlc3VsdHNbJ2Vycm9yJ10gPT0gXCJJbnZhbGlkIHVzZXJuYW1lIGFuZC9vciBwYXNzd29yZC5cIikge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHRzWydjb2RlJ10gPSAnMTAwJztcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGxvZ2luUHJvbWlzZS5yZXNvbHZlKHJlc3VsdHMpO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gbG9naW5Qcm9taXNlLnByb21pc2U7XG4gICAgfVxuXG4gICAgZmJMb2dpbih0b2tlbik6IFEuSVByb21pc2U8e30+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIucXVlcnkoJ3VzZXIvZmJfY29ubmVjdC8/YWNjZXNzX3Rva2VuPScgKyB0b2tlbilcbiAgICB9XG5cbiAgICBpc0F1dGhvcml6ZWQoY29va2llKTogUS5JUHJvbWlzZTx7fT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5kYi5xdWVyeSgndXNlci92YWxpZGF0ZV9hdXRoX2Nvb2tpZS8/Y29va2llPScgKyBjb29raWUpXG4gICAgfVxuXG4gICAgZ2V0VXNlckluZm8odXNlcklkKTogUS5JUHJvbWlzZTx7fT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5kYi5xdWVyeSgndXNlci9nZXRfdXNlcmluZm8vP3VzZXJfaWQ9JyArIHVzZXJJZClcbiAgICB9XG5cbiAgICBnZXRVc2VyQXZhdGFyVXJsKHVzZXJJZCk6IFEuSVByb21pc2U8VXNlckF2YXRhcj4ge1xuICAgICAgICB2YXIgZGVmZXJyZWQgPSBRLmRlZmVyKCk7XG4gICAgICAgIHZhciBxdWVyeSA9IFwiU0VMRUNUIG1ldGFfdmFsdWUgRlJPTSB3cDJfdXNlcm1ldGEgV0hFUkUgdXNlcl9pZD1cIiArIHVzZXJJZCArIFwiIEFORCBtZXRhX2tleT0na2xlb19mYl9waWN0dXJlJyBcIjtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHRoaXMuZGIucXVlcnlfZGIocXVlcnkpXG4gICAgICAgICAgICAgICAgLnRoZW4oKHJlc3BvbnNlOiBhbnlbXSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnZ2V0VXNlckF2YXRhclVybCByZXNwb25zZSAnLCBKU09OLnN0cmluZ2lmeShyZXNwb25zZSkpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2UubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShuZXcgVXNlckF2YXRhcihyZXNwb25zZVswXS5tZXRhX3ZhbHVlKSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKG5ldyBVc2VyQXZhdGFyKCcnKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ2dldFVzZXJBdmF0YXJVcmwgZXJyb3IgJywgZXJyb3IpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlO1xuICAgIH1cblxuICAgIGdldFVzZXJBdmF0YXIodXNlcklkLCB0eXBlKTogUS5JUHJvbWlzZTxVc2VyQXZhdGFyPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmRiLnF1ZXJ5KCd1c2VyL2dldF9hdmF0YXIvP3VzZXJfaWQ9JyArIHVzZXJJZCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICcmdHlwZT0nICsgdHlwZSk7XG4gICAgfVxuXG4gICAgcmVzZXRQYXNzd29yZCh1c2VybmFtZSk6IFEuSVByb21pc2U8e30+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIucXVlcnkoJ3VzZXIvcmV0cmlldmVfcGFzc3dvcmQvP3VzZXJfbG9naW49JyArIHVzZXJuYW1lKVxuICAgIH1cbn07XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=