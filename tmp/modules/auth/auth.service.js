/// <reference path="../../../typings/tsd.d.ts" />
/// <reference path="../connection/connection.service.ts" />
var Q = require("q");
var connection = require('../connection/connection.service');
var AuthService = (function () {
    function AuthService() {
        this.db = connection.service;
    }
    AuthService.prototype.getUserAvatar = function (userId, type) {
        return this.db.query('user/get_avatar/?user_id=' + userId + '&type=' + type);
    };
    AuthService.prototype.getNonce = function (controller, method) {
        return this.db.query('core/get_nonce/?controller=' + controller + '&method=' + method);
    };
    AuthService.prototype.register = function (username, email, password, display_name, years, country, school, ob) {
        var _this = this;
        var _promisesList = [];
        var registerPromise = Q.defer();
        this.getNonce('user', 'register').then(function (nonce) {
            _this.db.query('user/register/?username=' + username + '&email=' + email + '&password=' + password + '&nonce=' + nonce['nonce'] + '&notify=yes' + '&user_registered=yes' + '&display_name=' + display_name).then(function (results) {
                var i = [0, 1, 2, 3, 4];
                var fieldIds = [1, 645, 2, 4, 646];
                var fieldValues = [display_name, years, country, school, ob];
                if (results['status'] == 'error') {
                    if (results['error'] == "E-mail address is already in use.") {
                        results['code'] = '000';
                    }
                    ;
                    if (results['error'] == "Username already exists.") {
                        results['code'] = '001';
                    }
                    ;
                    registerPromise.resolve(results);
                    return registerPromise.promise;
                }
                else {
                    var userId = results['user_id'];
                    i.forEach(function (id) {
                        var xProfilePromise = Q.defer();
                        _promisesList.push(xProfilePromise.promise);
                        // if years value
                        if (fieldIds[id] == 645) {
                            // number value
                            var xProfileQuery = "INSERT INTO wp2_bp_xprofile_data (id, field_id, user_id, value, last_updated) " + "VALUES (null," + fieldIds[id] + "," + userId + "," + fieldValues[id] + ",'" + new Date().toISOString() + "')";
                        }
                        else {
                            // string value
                            var xProfileQuery = "INSERT INTO wp2_bp_xprofile_data (id, field_id, user_id, value, last_updated) " + "VALUES (null," + fieldIds[id] + "," + userId + ",'" + fieldValues[id] + "','" + new Date().toISOString() + "')";
                        }
                        ;
                        _this.db.query_db(xProfileQuery).then(function (data) {
                            xProfilePromise.resolve(data);
                        });
                    });
                    Q.all(_promisesList).then(function (values) {
                        results['username'] = username;
                        results['email'] = email;
                        results['display_name'] = display_name;
                        results['years'] = years;
                        results['country'] = country;
                        results['school'] = school;
                        results['ob'] = ob;
                        registerPromise.resolve(results);
                    });
                }
                ;
            });
        });
        return registerPromise.promise;
    };
    AuthService.prototype.login = function (username, password) {
        var loginPromise = Q.defer();
        this.db.query('user/generate_auth_cookie/?username=' + username + '&password=' + password).then(function (results) {
            if (results['status'] == 'error') {
                if (results['error'] == "Invalid username and/or password.") {
                    results['code'] = '100';
                }
                ;
            }
            ;
            loginPromise.resolve(results);
        });
        return loginPromise.promise;
    };
    AuthService.prototype.fbLogin = function (token) {
        return this.db.query('user/fb_connect/?access_token=' + token);
    };
    AuthService.prototype.isAuthorized = function (cookie) {
        return this.db.query('user/validate_auth_cookie/?cookie=' + cookie);
    };
    AuthService.prototype.getUserInfo = function (userId) {
        return this.db.query('user/get_userinfo/?user_id=' + userId);
    };
    AuthService.prototype.resetPassword = function (username) {
        return this.db.query('user/retrieve_password/?user_login=' + username);
    };
    return AuthService;
})();
exports.AuthService = AuthService;
;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZHVsZXMvYXV0aC9hdXRoLnNlcnZpY2UudHMiXSwibmFtZXMiOlsiQXV0aFNlcnZpY2UiLCJBdXRoU2VydmljZS5jb25zdHJ1Y3RvciIsIkF1dGhTZXJ2aWNlLmdldFVzZXJBdmF0YXIiLCJBdXRoU2VydmljZS5nZXROb25jZSIsIkF1dGhTZXJ2aWNlLnJlZ2lzdGVyIiwiQXV0aFNlcnZpY2UubG9naW4iLCJBdXRoU2VydmljZS5mYkxvZ2luIiwiQXV0aFNlcnZpY2UuaXNBdXRob3JpemVkIiwiQXV0aFNlcnZpY2UuZ2V0VXNlckluZm8iLCJBdXRoU2VydmljZS5yZXNldFBhc3N3b3JkIl0sIm1hcHBpbmdzIjoiQUFBQSxrREFBa0Q7QUFDbEQsNERBQTREO0FBRzVELElBQU8sQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDO0FBQ3hCLElBQU8sVUFBVSxXQUFXLGtDQUFrQyxDQUFDLENBQUM7QUFrQmhFLElBQWEsV0FBVztJQUF4QkEsU0FBYUEsV0FBV0E7UUFDWkMsT0FBRUEsR0FBR0EsVUFBVUEsQ0FBQ0EsT0FBT0EsQ0FBQ0E7SUErR3BDQSxDQUFDQTtJQTdHR0QsbUNBQWFBLEdBQWJBLFVBQWNBLE1BQU1BLEVBQUVBLElBQUlBO1FBQ3RCRSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxLQUFLQSxDQUFDQSwyQkFBMkJBLEdBQUdBLE1BQU1BLEdBQ3JEQSxRQUFRQSxHQUFHQSxJQUFJQSxDQUFDQSxDQUFDQTtJQUN6QkEsQ0FBQ0E7SUFFREYsOEJBQVFBLEdBQVJBLFVBQVNBLFVBQVVBLEVBQUVBLE1BQU1BO1FBQ3ZCRyxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxLQUFLQSxDQUFDQSw2QkFBNkJBLEdBQUdBLFVBQVVBLEdBQzFDQSxVQUFVQSxHQUFHQSxNQUFNQSxDQUFDQSxDQUFBQTtJQUM3Q0EsQ0FBQ0E7SUFFREgsOEJBQVFBLEdBQVJBLFVBQVNBLFFBQVFBLEVBQUVBLEtBQUtBLEVBQUVBLFFBQVFBLEVBQUVBLFlBQVlBLEVBQUVBLEtBQUtBLEVBQUVBLE9BQU9BLEVBQUVBLE1BQU1BLEVBQUVBLEVBQUVBO1FBQTVFSSxpQkFrRUNBO1FBakVHQSxJQUFJQSxhQUFhQSxHQUFHQSxFQUFFQSxDQUFDQTtRQUN2QkEsSUFBSUEsZUFBZUEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsS0FBS0EsRUFBRUEsQ0FBQ0E7UUFDaENBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLE1BQU1BLEVBQUVBLFVBQVVBLENBQUNBLENBQzVCQSxJQUFJQSxDQUFDQSxVQUFDQSxLQUFLQTtZQUNSQSxLQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxLQUFLQSxDQUFDQSwwQkFBMEJBLEdBQUdBLFFBQVFBLEdBQzlCQSxTQUFTQSxHQUFHQSxLQUFLQSxHQUNqQkEsWUFBWUEsR0FBR0EsUUFBUUEsR0FDdkJBLFNBQVNBLEdBQUdBLEtBQUtBLENBQUNBLE9BQU9BLENBQUNBLEdBQzFCQSxhQUFhQSxHQUNiQSxzQkFBc0JBLEdBQ3RCQSxnQkFBZ0JBLEdBQUdBLFlBQVlBLENBQUNBLENBQ2hEQSxJQUFJQSxDQUFDQSxVQUFDQSxPQUFPQTtnQkFDVkEsSUFBSUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ3hCQSxJQUFJQSxRQUFRQSxHQUFHQSxDQUFDQSxDQUFDQSxFQUFFQSxHQUFHQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxFQUFFQSxHQUFHQSxDQUFDQSxDQUFDQTtnQkFDbkNBLElBQUlBLFdBQVdBLEdBQUdBLENBQUNBLFlBQVlBLEVBQUVBLEtBQUtBLEVBQUVBLE9BQU9BLEVBQUVBLE1BQU1BLEVBQUVBLEVBQUVBLENBQUNBLENBQUNBO2dCQUU3REEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsSUFBSUEsT0FBT0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7b0JBQy9CQSxFQUFFQSxDQUFBQSxDQUFDQSxPQUFPQSxDQUFDQSxPQUFPQSxDQUFDQSxJQUFJQSxtQ0FBbUNBLENBQUNBLENBQUNBLENBQUNBO3dCQUN6REEsT0FBT0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsR0FBR0EsS0FBS0EsQ0FBQ0E7b0JBQzVCQSxDQUFDQTtvQkFBQUEsQ0FBQ0E7b0JBQ0ZBLEVBQUVBLENBQUFBLENBQUNBLE9BQU9BLENBQUNBLE9BQU9BLENBQUNBLElBQUlBLDBCQUEwQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7d0JBQ2hEQSxPQUFPQSxDQUFDQSxNQUFNQSxDQUFDQSxHQUFHQSxLQUFLQSxDQUFDQTtvQkFDNUJBLENBQUNBO29CQUFBQSxDQUFDQTtvQkFDRkEsZUFBZUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0E7b0JBQ2pDQSxNQUFNQSxDQUFDQSxlQUFlQSxDQUFDQSxPQUFPQSxDQUFDQTtnQkFDbkNBLENBQUNBO2dCQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtvQkFDSkEsSUFBSUEsTUFBTUEsR0FBR0EsT0FBT0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsQ0FBQ0E7b0JBRWhDQSxDQUFDQSxDQUFDQSxPQUFPQSxDQUFDQSxVQUFDQSxFQUFFQTt3QkFDVEEsSUFBSUEsZUFBZUEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsS0FBS0EsRUFBRUEsQ0FBQUE7d0JBQy9CQSxhQUFhQSxDQUFDQSxJQUFJQSxDQUFDQSxlQUFlQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQTt3QkFFNUNBLEFBQ0FBLGlCQURpQkE7d0JBQ2pCQSxFQUFFQSxDQUFDQSxDQUFDQSxRQUFRQSxDQUFDQSxFQUFFQSxDQUFDQSxJQUFJQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQTs0QkFDdEJBLEFBQ0FBLGVBRGVBO2dDQUNYQSxhQUFhQSxHQUFHQSxnRkFBZ0ZBLEdBQ3hFQSxlQUFlQSxHQUFHQSxRQUFRQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxHQUFHQSxHQUFHQSxNQUFNQSxHQUFHQSxHQUFHQSxHQUFHQSxXQUFXQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxJQUFJQSxHQUFHQSxJQUFJQSxJQUFJQSxFQUFFQSxDQUFDQSxXQUFXQSxFQUFFQSxHQUFHQSxJQUFJQSxDQUFDQTt3QkFDL0lBLENBQUNBO3dCQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTs0QkFDSkEsQUFDQUEsZUFEZUE7Z0NBQ1hBLGFBQWFBLEdBQUdBLGdGQUFnRkEsR0FDeEVBLGVBQWVBLEdBQUdBLFFBQVFBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLEdBQUdBLEdBQUdBLE1BQU1BLEdBQUdBLElBQUlBLEdBQUdBLFdBQVdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLEtBQUtBLEdBQUdBLElBQUlBLElBQUlBLEVBQUVBLENBQUNBLFdBQVdBLEVBQUVBLEdBQUdBLElBQUlBLENBQUNBO3dCQUNqSkEsQ0FBQ0E7d0JBQUFBLENBQUNBO3dCQUVGQSxLQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxRQUFRQSxDQUFDQSxhQUFhQSxDQUFDQSxDQUMxQkEsSUFBSUEsQ0FBQ0EsVUFBQ0EsSUFBSUE7NEJBQ1BBLGVBQWVBLENBQUNBLE9BQU9BLENBQUNBLElBQUlBLENBQUNBLENBQUNBO3dCQUNsQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQUE7b0JBQ1ZBLENBQUNBLENBQUNBLENBQUNBO29CQUVIQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxhQUFhQSxDQUFDQSxDQUNmQSxJQUFJQSxDQUFDQSxVQUFDQSxNQUFNQTt3QkFDVEEsT0FBT0EsQ0FBQ0EsVUFBVUEsQ0FBQ0EsR0FBR0EsUUFBUUEsQ0FBQ0E7d0JBQy9CQSxPQUFPQSxDQUFDQSxPQUFPQSxDQUFDQSxHQUFHQSxLQUFLQSxDQUFDQTt3QkFDekJBLE9BQU9BLENBQUNBLGNBQWNBLENBQUNBLEdBQUdBLFlBQVlBLENBQUNBO3dCQUN2Q0EsT0FBT0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsR0FBR0EsS0FBS0EsQ0FBQ0E7d0JBQ3pCQSxPQUFPQSxDQUFDQSxTQUFTQSxDQUFDQSxHQUFHQSxPQUFPQSxDQUFDQTt3QkFDN0JBLE9BQU9BLENBQUNBLFFBQVFBLENBQUNBLEdBQUdBLE1BQU1BLENBQUNBO3dCQUMzQkEsT0FBT0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsR0FBR0EsRUFBRUEsQ0FBQ0E7d0JBQ25CQSxlQUFlQSxDQUFDQSxPQUFPQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQTtvQkFDckNBLENBQUNBLENBQUNBLENBQUNBO2dCQUNYQSxDQUFDQTtnQkFBQUEsQ0FBQ0E7WUFDTkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDWEEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFFUEEsTUFBTUEsQ0FBQ0EsZUFBZUEsQ0FBQ0EsT0FBT0EsQ0FBQ0E7SUFDbkNBLENBQUNBO0lBRURKLDJCQUFLQSxHQUFMQSxVQUFNQSxRQUFRQSxFQUFFQSxRQUFRQTtRQUNwQkssSUFBSUEsWUFBWUEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsS0FBS0EsRUFBRUEsQ0FBQ0E7UUFDN0JBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLEtBQUtBLENBQUNBLHNDQUFzQ0EsR0FBR0EsUUFBUUEsR0FDMUNBLFlBQVlBLEdBQUdBLFFBQVFBLENBQUNBLENBQzVDQSxJQUFJQSxDQUFDQSxVQUFDQSxPQUFPQTtZQUNWQSxFQUFFQSxDQUFDQSxDQUFDQSxPQUFPQSxDQUFDQSxRQUFRQSxDQUFDQSxJQUFJQSxPQUFPQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDL0JBLEVBQUVBLENBQUFBLENBQUNBLE9BQU9BLENBQUNBLE9BQU9BLENBQUNBLElBQUlBLG1DQUFtQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7b0JBQ3pEQSxPQUFPQSxDQUFDQSxNQUFNQSxDQUFDQSxHQUFHQSxLQUFLQSxDQUFDQTtnQkFDNUJBLENBQUNBO2dCQUFBQSxDQUFDQTtZQUNOQSxDQUFDQTtZQUFBQSxDQUFDQTtZQUNGQSxZQUFZQSxDQUFDQSxPQUFPQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQTtRQUNsQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFFSEEsTUFBTUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsT0FBT0EsQ0FBQ0E7SUFDaENBLENBQUNBO0lBRURMLDZCQUFPQSxHQUFQQSxVQUFRQSxLQUFLQTtRQUNUTSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxLQUFLQSxDQUFDQSxnQ0FBZ0NBLEdBQUdBLEtBQUtBLENBQUNBLENBQUFBO0lBQ2xFQSxDQUFDQTtJQUVETixrQ0FBWUEsR0FBWkEsVUFBYUEsTUFBTUE7UUFDZk8sTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsS0FBS0EsQ0FBQ0Esb0NBQW9DQSxHQUFHQSxNQUFNQSxDQUFDQSxDQUFBQTtJQUN2RUEsQ0FBQ0E7SUFFRFAsaUNBQVdBLEdBQVhBLFVBQVlBLE1BQU1BO1FBQ2RRLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLEtBQUtBLENBQUNBLDZCQUE2QkEsR0FBR0EsTUFBTUEsQ0FBQ0EsQ0FBQUE7SUFDaEVBLENBQUNBO0lBRURSLG1DQUFhQSxHQUFiQSxVQUFjQSxRQUFRQTtRQUNsQlMsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EscUNBQXFDQSxHQUFHQSxRQUFRQSxDQUFDQSxDQUFBQTtJQUMxRUEsQ0FBQ0E7SUFDTFQsa0JBQUNBO0FBQURBLENBaEhBLEFBZ0hDQSxJQUFBO0FBaEhZLG1CQUFXLEdBQVgsV0FnSFosQ0FBQTtBQUFBLENBQUMiLCJmaWxlIjoibW9kdWxlcy9hdXRoL2F1dGguc2VydmljZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi8uLi90eXBpbmdzL3RzZC5kLnRzXCIgLz5cbi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi9jb25uZWN0aW9uL2Nvbm5lY3Rpb24uc2VydmljZS50c1wiIC8+XG5cblxuaW1wb3J0IFEgPSByZXF1aXJlKFwicVwiKTtcbmltcG9ydCBjb25uZWN0aW9uID0gcmVxdWlyZSgnLi4vY29ubmVjdGlvbi9jb25uZWN0aW9uLnNlcnZpY2UnKTtcblxuXG5leHBvcnQgaW50ZXJmYWNlIElBdXRoU2VydmljZSB7XG4gICAgLy8gR0VUXG4gICAgZ2V0Tm9uY2UoY29udHJvbGxlciwgbWV0aG9kKTogUS5JUHJvbWlzZTx7fT47XG4gICAgZ2V0VXNlckluZm8odXNlcklkKTogUS5JUHJvbWlzZTx7fT47XG4gICAgZ2V0VXNlckF2YXRhcih1c2VySWQsIHR5cGUpOiBRLklQcm9taXNlPHt9PjtcblxuICAgIFxuICAgIC8vIFBPU1RcbiAgICByZWdpc3Rlcih1c2VybmFtZSwgZW1haWwsIHBhc3N3b3JkLCBkaXNwbGF5X25hbWUsIHllYXJzLCBjb3VudHJ5LCBzY2hvb2wsIG9iKTogUS5JUHJvbWlzZTx7fT47XG4gICAgbG9naW4odXNlcm5hbWUsIHBhc3N3b3JkKTogUS5JUHJvbWlzZTx7fT47XG4gICAgZmJMb2dpbih0b2tlbik6IFEuSVByb21pc2U8e30+O1xuICAgIGlzQXV0aG9yaXplZChjb29raWUpOiBRLklQcm9taXNlPHt9PjtcbiAgICByZXNldFBhc3N3b3JkKHVzZXJuYW1lKTogUS5JUHJvbWlzZTx7fT47XG59XG5cbmV4cG9ydCBjbGFzcyBBdXRoU2VydmljZSBpbXBsZW1lbnRzIElBdXRoU2VydmljZSB7XG4gICAgcHJpdmF0ZSBkYiA9IGNvbm5lY3Rpb24uc2VydmljZTtcblxuICAgIGdldFVzZXJBdmF0YXIodXNlcklkLCB0eXBlKSA6IFEuSVByb21pc2U8e30+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIucXVlcnkoJ3VzZXIvZ2V0X2F2YXRhci8/dXNlcl9pZD0nICsgdXNlcklkICtcbiAgICAgICAgICAgICcmdHlwZT0nICsgdHlwZSk7XG4gICAgfVxuXG4gICAgZ2V0Tm9uY2UoY29udHJvbGxlciwgbWV0aG9kKTogUS5JUHJvbWlzZTx7fT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5kYi5xdWVyeSgnY29yZS9nZXRfbm9uY2UvP2NvbnRyb2xsZXI9JyArIGNvbnRyb2xsZXIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnJm1ldGhvZD0nICsgbWV0aG9kKVxuICAgIH1cblxuICAgIHJlZ2lzdGVyKHVzZXJuYW1lLCBlbWFpbCwgcGFzc3dvcmQsIGRpc3BsYXlfbmFtZSwgeWVhcnMsIGNvdW50cnksIHNjaG9vbCwgb2IpOiBRLklQcm9taXNlPHt9PiB7XG4gICAgICAgIHZhciBfcHJvbWlzZXNMaXN0ID0gW107XG4gICAgICAgIHZhciByZWdpc3RlclByb21pc2UgPSBRLmRlZmVyKCk7XG4gICAgICAgIHRoaXMuZ2V0Tm9uY2UoJ3VzZXInLCAncmVnaXN0ZXInKVxuICAgICAgICAgICAgLnRoZW4oKG5vbmNlKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5kYi5xdWVyeSgndXNlci9yZWdpc3Rlci8/dXNlcm5hbWU9JyArIHVzZXJuYW1lICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnJmVtYWlsPScgKyBlbWFpbCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyZwYXNzd29yZD0nICsgcGFzc3dvcmQgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcmbm9uY2U9JyArIG5vbmNlWydub25jZSddICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnJm5vdGlmeT15ZXMnICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnJnVzZXJfcmVnaXN0ZXJlZD15ZXMnICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnJmRpc3BsYXlfbmFtZT0nICsgZGlzcGxheV9uYW1lKVxuICAgICAgICAgICAgICAgICAgICAudGhlbigocmVzdWx0cykgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGkgPSBbMCwgMSwgMiwgMywgNF07XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZmllbGRJZHMgPSBbMSwgNjQ1LCAyLCA0LCA2NDZdO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGZpZWxkVmFsdWVzID0gW2Rpc3BsYXlfbmFtZSwgeWVhcnMsIGNvdW50cnksIHNjaG9vbCwgb2JdO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0c1snc3RhdHVzJ10gPT0gJ2Vycm9yJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHJlc3VsdHNbJ2Vycm9yJ10gPT0gXCJFLW1haWwgYWRkcmVzcyBpcyBhbHJlYWR5IGluIHVzZS5cIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzWydjb2RlJ10gPSAnMDAwJztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHJlc3VsdHNbJ2Vycm9yJ10gPT0gXCJVc2VybmFtZSBhbHJlYWR5IGV4aXN0cy5cIikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzWydjb2RlJ10gPSAnMDAxJztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZ2lzdGVyUHJvbWlzZS5yZXNvbHZlKHJlc3VsdHMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZWdpc3RlclByb21pc2UucHJvbWlzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHVzZXJJZCA9IHJlc3VsdHNbJ3VzZXJfaWQnXTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGkuZm9yRWFjaCgoaWQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHhQcm9maWxlUHJvbWlzZSA9IFEuZGVmZXIoKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfcHJvbWlzZXNMaXN0LnB1c2goeFByb2ZpbGVQcm9taXNlLnByb21pc2UpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlmIHllYXJzIHZhbHVlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmaWVsZElkc1tpZF0gPT0gNjQ1KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBudW1iZXIgdmFsdWVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB4UHJvZmlsZVF1ZXJ5ID0gXCJJTlNFUlQgSU5UTyB3cDJfYnBfeHByb2ZpbGVfZGF0YSAoaWQsIGZpZWxkX2lkLCB1c2VyX2lkLCB2YWx1ZSwgbGFzdF91cGRhdGVkKSBcIiArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJWQUxVRVMgKG51bGwsXCIgKyBmaWVsZElkc1tpZF0gKyBcIixcIiArIHVzZXJJZCArIFwiLFwiICsgZmllbGRWYWx1ZXNbaWRdICsgXCIsJ1wiICsgbmV3IERhdGUoKS50b0lTT1N0cmluZygpICsgXCInKVwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gc3RyaW5nIHZhbHVlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgeFByb2ZpbGVRdWVyeSA9IFwiSU5TRVJUIElOVE8gd3AyX2JwX3hwcm9maWxlX2RhdGEgKGlkLCBmaWVsZF9pZCwgdXNlcl9pZCwgdmFsdWUsIGxhc3RfdXBkYXRlZCkgXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiVkFMVUVTIChudWxsLFwiICsgZmllbGRJZHNbaWRdICsgXCIsXCIgKyB1c2VySWQgKyBcIiwnXCIgKyBmaWVsZFZhbHVlc1tpZF0gKyBcIicsJ1wiICsgbmV3IERhdGUoKS50b0lTT1N0cmluZygpICsgXCInKVwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGIucXVlcnlfZGIoeFByb2ZpbGVRdWVyeSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKChkYXRhKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeFByb2ZpbGVQcm9taXNlLnJlc29sdmUoZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgUS5hbGwoX3Byb21pc2VzTGlzdClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oKHZhbHVlcykgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0c1sndXNlcm5hbWUnXSA9IHVzZXJuYW1lO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0c1snZW1haWwnXSA9IGVtYWlsO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0c1snZGlzcGxheV9uYW1lJ10gPSBkaXNwbGF5X25hbWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzWyd5ZWFycyddID0geWVhcnM7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzWydjb3VudHJ5J10gPSBjb3VudHJ5O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0c1snc2Nob29sJ10gPSBzY2hvb2w7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzWydvYiddID0gb2I7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWdpc3RlclByb21pc2UucmVzb2x2ZShyZXN1bHRzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiByZWdpc3RlclByb21pc2UucHJvbWlzZTtcbiAgICB9XG5cbiAgICBsb2dpbih1c2VybmFtZSwgcGFzc3dvcmQpOiBRLklQcm9taXNlPHt9PiB7XG4gICAgICAgIHZhciBsb2dpblByb21pc2UgPSBRLmRlZmVyKCk7XG4gICAgICAgIHRoaXMuZGIucXVlcnkoJ3VzZXIvZ2VuZXJhdGVfYXV0aF9jb29raWUvP3VzZXJuYW1lPScgKyB1c2VybmFtZSArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICcmcGFzc3dvcmQ9JyArIHBhc3N3b3JkKVxuICAgICAgICAudGhlbigocmVzdWx0cykgPT4ge1xuICAgICAgICAgICAgaWYgKHJlc3VsdHNbJ3N0YXR1cyddID09ICdlcnJvcicpIHtcbiAgICAgICAgICAgICAgICBpZihyZXN1bHRzWydlcnJvciddID09IFwiSW52YWxpZCB1c2VybmFtZSBhbmQvb3IgcGFzc3dvcmQuXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0c1snY29kZSddID0gJzEwMCc7XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBsb2dpblByb21pc2UucmVzb2x2ZShyZXN1bHRzKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGxvZ2luUHJvbWlzZS5wcm9taXNlO1xuICAgIH1cblxuICAgIGZiTG9naW4odG9rZW4pOiBRLklQcm9taXNlPHt9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmRiLnF1ZXJ5KCd1c2VyL2ZiX2Nvbm5lY3QvP2FjY2Vzc190b2tlbj0nICsgdG9rZW4pXG4gICAgfVxuXG4gICAgaXNBdXRob3JpemVkKGNvb2tpZSk6IFEuSVByb21pc2U8e30+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIucXVlcnkoJ3VzZXIvdmFsaWRhdGVfYXV0aF9jb29raWUvP2Nvb2tpZT0nICsgY29va2llKVxuICAgIH1cblxuICAgIGdldFVzZXJJbmZvKHVzZXJJZCk6IFEuSVByb21pc2U8e30+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIucXVlcnkoJ3VzZXIvZ2V0X3VzZXJpbmZvLz91c2VyX2lkPScgKyB1c2VySWQpXG4gICAgfVxuXG4gICAgcmVzZXRQYXNzd29yZCh1c2VybmFtZSk6IFEuSVByb21pc2U8e30+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIucXVlcnkoJ3VzZXIvcmV0cmlldmVfcGFzc3dvcmQvP3VzZXJfbG9naW49JyArIHVzZXJuYW1lKVxuICAgIH1cbn07XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=