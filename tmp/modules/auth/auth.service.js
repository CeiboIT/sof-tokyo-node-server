/// <reference path="../../../typings/tsd.d.ts" />
/// <reference path="../connection/connection.service.ts" />
var Q = require("q");
var connection = require('../connection/connection.service');
var AuthService = (function () {
    function AuthService() {
        this.db = connection.service;
    }
    AuthService.prototype.getNonce = function (controller, method) {
        return this.db.query('core/get_nonce/?controller=' + controller + '&method=' + method);
    };
    AuthService.prototype.register = function (username, email, display_name, years, country, school, ob) {
        var _this = this;
        var _promisesList = [];
        var registerPromise = Q.defer();
        this.getNonce('user', 'register').then(function (nonce) {
            _this.db.query('user/register/?username=' + username + '&email=' + email + '&nonce=' + nonce['nonce'] + '&display_name=' + display_name).then(function (results) {
                var i = [0, 1, 2, 3, 4];
                var fieldIds = [1, 645, 2, 4, 646];
                var fieldValues = [display_name, years, country, school, ob];
                if (results['status'] == 'error') {
                    registerPromise.resolve(results);
                    return registerPromise.promise;
                }
                else {
                    var userId = results['user_id'];
                    i.forEach(function (id) {
                        var xProfilePromise = Q.defer();
                        _promisesList.push(xProfilePromise.promise);
                        // if years value
                        if (fieldIds[id] == 645) {
                            // number value
                            var xProfileQuery = "INSERT INTO wp2_bp_xprofile_data (id, field_id, user_id, value, last_updated) " + "VALUES (null," + fieldIds[id] + "," + userId + "," + fieldValues[id] + ",'" + new Date().toISOString() + "')";
                        }
                        else {
                            // string value
                            var xProfileQuery = "INSERT INTO wp2_bp_xprofile_data (id, field_id, user_id, value, last_updated) " + "VALUES (null," + fieldIds[id] + "," + userId + ",'" + fieldValues[id] + "','" + new Date().toISOString() + "')";
                        }
                        ;
                        _this.db.query_db(xProfileQuery).then(function (data) {
                            xProfilePromise.resolve(data);
                        });
                    });
                    Q.all(_promisesList).then(function (values) {
                        results['username'] = username;
                        results['email'] = email;
                        results['display_name'] = display_name;
                        results['years'] = years;
                        results['country'] = country;
                        results['school'] = school;
                        results['ob'] = ob;
                        registerPromise.resolve(results);
                    });
                }
                ;
            });
        });
        return registerPromise.promise;
    };
    AuthService.prototype.login = function (username, password) {
        return this.db.query('user/generate_auth_cookie/?username=' + username + '&password=' + password);
    };
    AuthService.prototype.fbLogin = function (token) {
        return this.db.query('user/fb_connect/?access_token=' + token);
    };
    AuthService.prototype.isAuthorized = function (cookie) {
        return this.db.query('user/validate_auth_cookie/?cookie=' + cookie);
    };
    AuthService.prototype.getUserInfo = function (userId) {
        return this.db.query('user/get_userinfo/?user_id=' + userId);
    };
    AuthService.prototype.getUserAvatar = function (userId, type) {
        return this.db.query('user/get_avatar/?user_id=' + userId + '&type=' + type);
    };
    AuthService.prototype.resetPassword = function (username) {
        return this.db.query('user/retrieve_password/?user_login=' + username);
    };
    return AuthService;
})();
exports.AuthService = AuthService;
;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZHVsZXMvYXV0aC9hdXRoLnNlcnZpY2UudHMiXSwibmFtZXMiOlsiQXV0aFNlcnZpY2UiLCJBdXRoU2VydmljZS5jb25zdHJ1Y3RvciIsIkF1dGhTZXJ2aWNlLmdldE5vbmNlIiwiQXV0aFNlcnZpY2UucmVnaXN0ZXIiLCJBdXRoU2VydmljZS5sb2dpbiIsIkF1dGhTZXJ2aWNlLmZiTG9naW4iLCJBdXRoU2VydmljZS5pc0F1dGhvcml6ZWQiLCJBdXRoU2VydmljZS5nZXRVc2VySW5mbyIsIkF1dGhTZXJ2aWNlLmdldFVzZXJBdmF0YXIiLCJBdXRoU2VydmljZS5yZXNldFBhc3N3b3JkIl0sIm1hcHBpbmdzIjoiQUFBQSxrREFBa0Q7QUFDbEQsNERBQTREO0FBRTVELElBQU8sQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDO0FBQ3hCLElBQU8sVUFBVSxXQUFXLGtDQUFrQyxDQUFDLENBQUM7QUFlaEUsSUFBYSxXQUFXO0lBQXhCQSxTQUFhQSxXQUFXQTtRQUNaQyxPQUFFQSxHQUFHQSxVQUFVQSxDQUFDQSxPQUFPQSxDQUFDQTtJQTJGcENBLENBQUNBO0lBekZHRCw4QkFBUUEsR0FBUkEsVUFBU0EsVUFBVUEsRUFBRUEsTUFBTUE7UUFDdkJFLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLEtBQUtBLENBQUNBLDZCQUE2QkEsR0FBR0EsVUFBVUEsR0FDMUNBLFVBQVVBLEdBQUdBLE1BQU1BLENBQUNBLENBQUFBO0lBQzdDQSxDQUFDQTtJQUVERiw4QkFBUUEsR0FBUkEsVUFBU0EsUUFBUUEsRUFBRUEsS0FBS0EsRUFBRUEsWUFBWUEsRUFBRUEsS0FBS0EsRUFBRUEsT0FBT0EsRUFBRUEsTUFBTUEsRUFBRUEsRUFBRUE7UUFBbEVHLGlCQXlEQ0E7UUF4REdBLElBQUlBLGFBQWFBLEdBQUdBLEVBQUVBLENBQUNBO1FBQ3ZCQSxJQUFJQSxlQUFlQSxHQUFHQSxDQUFDQSxDQUFDQSxLQUFLQSxFQUFFQSxDQUFDQTtRQUNoQ0EsSUFBSUEsQ0FB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LENBQUFBO0lBQ2xFQSxDQUFDQTtJQUVETCxrQ0FBWUEsR0FBWkEsVUFBYUEsTUFBTUE7UUFDZk0sTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsS0FBS0EsQ0FBQ0Esb0NBQW9DQSxHQUFHQSxNQUFNQSxDQUFDQSxDQUFBQTtJQUN2RUEsQ0FBQ0E7SUFFRE4saUNBQVdBLEdBQVhBLFVBQVlBLE1BQU1BO1FBQ2RPLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLEtBQUtBLENBQUNBLDZCQUE2QkEsR0FBR0EsTUFBTUEsQ0FBQ0EsQ0FBQUE7SUFDaEVBLENBQUNBO0lBRURQLG1DQUFhQSxHQUFiQSxVQUFjQSxNQUFNQSxFQUFFQSxJQUFJQTtRQUN0QlEsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsMkJBQTJCQSxHQUFHQSxNQUFNQSxHQUNwQ0EsUUFBUUEsR0FBR0EsSUFBSUEsQ0FBQ0EsQ0FBQUE7SUFDekNBLENBQUNBO0lBRURSLG1DQUFhQSxHQUFiQSxVQUFjQSxRQUFRQTtRQUNsQlMsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EscUNBQXFDQSxHQUFHQSxRQUFRQSxDQUFDQSxDQUFBQTtJQUMxRUEsQ0FBQ0E7SUFDTFQsa0JBQUNBO0FBQURBLENBNUZBLEFBNEZDQSxJQUFBO0FBNUZZLG1CQUFXLEdBQVgsV0E0RlosQ0FBQTtBQUFBLENBQUMiLCJmaWxlIjoibW9kdWxlcy9hdXRoL2F1dGguc2VydmljZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi8uLi90eXBpbmdzL3RzZC5kLnRzXCIgLz5cbi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi9jb25uZWN0aW9uL2Nvbm5lY3Rpb24uc2VydmljZS50c1wiIC8+XG5cbmltcG9ydCBRID0gcmVxdWlyZShcInFcIik7XG5pbXBvcnQgY29ubmVjdGlvbiA9IHJlcXVpcmUoJy4uL2Nvbm5lY3Rpb24vY29ubmVjdGlvbi5zZXJ2aWNlJyk7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUF1dGhTZXJ2aWNlIHtcbiAgICAvLyBHRVRcbiAgICBnZXROb25jZShjb250cm9sbGVyLCBtZXRob2QpOiBRLklQcm9taXNlPHt9PjtcbiAgICBnZXRVc2VySW5mbyh1c2VySWQpOiBRLklQcm9taXNlPHt9PjtcbiAgICBnZXRVc2VyQXZhdGFyKHVzZXJJZCwgdHlwZSk6IFEuSVByb21pc2U8e30+O1xuICAgIC8vIFBPU1RcbiAgICByZWdpc3Rlcih1c2VybmFtZSwgZW1haWwsIGRpc3BsYXlfbmFtZSwgeWVhcnMsIGNvdW50cnksIHNjaG9vbCwgb2IpOiBRLklQcm9taXNlPHt9PjtcbiAgICBsb2dpbih1c2VybmFtZSwgcGFzc3dvcmQpOiBRLklQcm9taXNlPHt9PjtcbiAgICBmYkxvZ2luKHRva2VuKTogUS5JUHJvbWlzZTx7fT47XG4gICAgaXNBdXRob3JpemVkKGNvb2tpZSk6IFEuSVByb21pc2U8e30+O1xuICAgIHJlc2V0UGFzc3dvcmQodXNlcm5hbWUpOiBRLklQcm9taXNlPHt9Pjtcbn1cblxuZXhwb3J0IGNsYXNzIEF1dGhTZXJ2aWNlIGltcGxlbWVudHMgSUF1dGhTZXJ2aWNlIHtcbiAgICBwcml2YXRlIGRiID0gY29ubmVjdGlvbi5zZXJ2aWNlO1xuXG4gICAgZ2V0Tm9uY2UoY29udHJvbGxlciwgbWV0aG9kKTogUS5JUHJvbWlzZTx7fT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5kYi5xdWVyeSgnY29yZS9nZXRfbm9uY2UvP2NvbnRyb2xsZXI9JyArIGNvbnRyb2xsZXIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnJm1ldGhvZD0nICsgbWV0aG9kKVxuICAgIH1cblxuICAgIHJlZ2lzdGVyKHVzZXJuYW1lLCBlbWFpbCwgZGlzcGxheV9uYW1lLCB5ZWFycywgY291bnRyeSwgc2Nob29sLCBvYik6IFEuSVByb21pc2U8e30+IHtcbiAgICAgICAgdmFyIF9wcm9taXNlc0xpc3QgPSBbXTtcbiAgICAgICAgdmFyIHJlZ2lzdGVyUHJvbWlzZSA9IFEuZGVmZXIoKTtcbiAgICAgICAgdGhpcy5nZXROb25jZSgndXNlcicsICdyZWdpc3RlcicpXG4gICAgICAgICAgICAudGhlbigobm9uY2UpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmRiLnF1ZXJ5KCd1c2VyL3JlZ2lzdGVyLz91c2VybmFtZT0nICsgdXNlcm5hbWUgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcmZW1haWw9JyArIGVtYWlsICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnJm5vbmNlPScgKyBub25jZVsnbm9uY2UnXSArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyZkaXNwbGF5X25hbWU9JyArIGRpc3BsYXlfbmFtZSlcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oKHJlc3VsdHMpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpID0gWzAsIDEsIDIsIDMsIDRdO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGZpZWxkSWRzID0gWzEsIDY0NSwgMiwgNCwgNjQ2XTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBmaWVsZFZhbHVlcyA9IFtkaXNwbGF5X25hbWUsIHllYXJzLCBjb3VudHJ5LCBzY2hvb2wsIG9iXTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdHNbJ3N0YXR1cyddID09ICdlcnJvcicpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWdpc3RlclByb21pc2UucmVzb2x2ZShyZXN1bHRzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVnaXN0ZXJQcm9taXNlLnByb21pc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB1c2VySWQgPSByZXN1bHRzWyd1c2VyX2lkJ107XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpLmZvckVhY2goKGlkKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB4UHJvZmlsZVByb21pc2UgPSBRLmRlZmVyKClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3Byb21pc2VzTGlzdC5wdXNoKHhQcm9maWxlUHJvbWlzZS5wcm9taXNlKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBpZiB5ZWFycyB2YWx1ZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmllbGRJZHNbaWRdID09IDY0NSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbnVtYmVyIHZhbHVlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgeFByb2ZpbGVRdWVyeSA9IFwiSU5TRVJUIElOVE8gd3AyX2JwX3hwcm9maWxlX2RhdGEgKGlkLCBmaWVsZF9pZCwgdXNlcl9pZCwgdmFsdWUsIGxhc3RfdXBkYXRlZCkgXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiVkFMVUVTIChudWxsLFwiICsgZmllbGRJZHNbaWRdICsgXCIsXCIgKyB1c2VySWQgKyBcIixcIiArIGZpZWxkVmFsdWVzW2lkXSArIFwiLCdcIiArIG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSArIFwiJylcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHN0cmluZyB2YWx1ZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHhQcm9maWxlUXVlcnkgPSBcIklOU0VSVCBJTlRPIHdwMl9icF94cHJvZmlsZV9kYXRhIChpZCwgZmllbGRfaWQsIHVzZXJfaWQsIHZhbHVlLCBsYXN0X3VwZGF0ZWQpIFwiICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIlZBTFVFUyAobnVsbCxcIiArIGZpZWxkSWRzW2lkXSArIFwiLFwiICsgdXNlcklkICsgXCIsJ1wiICsgZmllbGRWYWx1ZXNbaWRdICsgXCInLCdcIiArIG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSArIFwiJylcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRiLnF1ZXJ5X2RiKHhQcm9maWxlUXVlcnkpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbigoZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhQcm9maWxlUHJvbWlzZS5yZXNvbHZlKGRhdGEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFEuYWxsKF9wcm9taXNlc0xpc3QpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKCh2YWx1ZXMpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHNbJ3VzZXJuYW1lJ10gPSB1c2VybmFtZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHNbJ2VtYWlsJ10gPSBlbWFpbDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHNbJ2Rpc3BsYXlfbmFtZSddID0gZGlzcGxheV9uYW1lO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0c1sneWVhcnMnXSA9IHllYXJzO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0c1snY291bnRyeSddID0gY291bnRyeTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHNbJ3NjaG9vbCddID0gc2Nob29sO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0c1snb2InXSA9IG9iO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVnaXN0ZXJQcm9taXNlLnJlc29sdmUocmVzdWx0cyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gcmVnaXN0ZXJQcm9taXNlLnByb21pc2U7XG4gICAgfVxuXG4gICAgbG9naW4odXNlcm5hbWUsIHBhc3N3b3JkKTogUS5JUHJvbWlzZTx7fT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5kYi5xdWVyeSgndXNlci9nZW5lcmF0ZV9hdXRoX2Nvb2tpZS8/dXNlcm5hbWU9JyArIHVzZXJuYW1lICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyZwYXNzd29yZD0nICsgcGFzc3dvcmQpXG4gICAgfVxuXG4gICAgZmJMb2dpbih0b2tlbik6IFEuSVByb21pc2U8e30+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIucXVlcnkoJ3VzZXIvZmJfY29ubmVjdC8/YWNjZXNzX3Rva2VuPScgKyB0b2tlbilcbiAgICB9XG5cbiAgICBpc0F1dGhvcml6ZWQoY29va2llKTogUS5JUHJvbWlzZTx7fT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5kYi5xdWVyeSgndXNlci92YWxpZGF0ZV9hdXRoX2Nvb2tpZS8/Y29va2llPScgKyBjb29raWUpXG4gICAgfVxuXG4gICAgZ2V0VXNlckluZm8odXNlcklkKTogUS5JUHJvbWlzZTx7fT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5kYi5xdWVyeSgndXNlci9nZXRfdXNlcmluZm8vP3VzZXJfaWQ9JyArIHVzZXJJZClcbiAgICB9XG5cbiAgICBnZXRVc2VyQXZhdGFyKHVzZXJJZCwgdHlwZSk6IFEuSVByb21pc2U8e30+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIucXVlcnkoJ3VzZXIvZ2V0X2F2YXRhci8/dXNlcl9pZD0nICsgdXNlcklkICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyZ0eXBlPScgKyB0eXBlKVxuICAgIH1cblxuICAgIHJlc2V0UGFzc3dvcmQodXNlcm5hbWUpOiBRLklQcm9taXNlPHt9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmRiLnF1ZXJ5KCd1c2VyL3JldHJpZXZlX3Bhc3N3b3JkLz91c2VyX2xvZ2luPScgKyB1c2VybmFtZSlcbiAgICB9XG59O1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9