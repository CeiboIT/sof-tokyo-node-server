/// <reference path="../../../typings/tsd.d.ts" />
/// <reference path="../connection/connection.service.ts" />
var Q = require("q");
var connection = require('../connection/connection.service');
var ProductsService = (function () {
    function ProductsService() {
        this.db = connection.service;
    }
    ProductsService.prototype.getProductsNew = function (page) {
        var _listPromise = Q.defer();
        this.db.query('core/?json=get_recent_posts&count=4&page=' + page).then(function (results) {
            _listPromise.resolve(results);
        });
        return _listPromise.promise;
    };
    ProductsService.prototype.getProductsList = function (page) {
        var _listPromise = Q.defer();
        this.db.query('core/?json=get_posts&count=4&page=' + page).then(function (results) {
            _listPromise.resolve(results);
        });
        return _listPromise.promise;
    };
    ProductsService.prototype.getProductById = function (productId) {
        return this.db.query('core/get_post/?id=' + productId);
    };
    ProductsService.prototype.getProductsByAuthor = function (authorId, page) {
        return this.db.query('core/get_author_posts/?count=4&id=' + authorId + '&page=' + page);
    };
    ProductsService.prototype.getProductsByCategory = function (categoryId, page) {
        return this.db.query('core/get_category_posts/?count=4&id=' + categoryId + '&page=' + page);
    };
    ProductsService.prototype.getProductsByTag = function (tagId, page) {
        return this.db.query('core/get_tag_posts/?count=4&id=' + tagId + '&page=' + page);
    };
    ProductsService.prototype.getProductsBySchool = function (schoolId, page) {
        var _this = this;
        var _listPromise = Q.defer();
        this.db.query('core/?json=get_posts&count=200').then(function (results) {
            var posts = results['posts'];
            _this.db.query_db("SELECT user_id FROM wp2_bp_xprofile_data WHERE value='" + schoolId + "' AND field_id=4").then(function (data) {
                var userIds = [];
                for (var i in data) {
                    userIds.push(data[i].user_id);
                }
                function inArray(myArray, myValue) {
                    var inArray = false;
                    myArray.map(function (key) {
                        if (key === myValue) {
                            inArray = true;
                        }
                    });
                    return inArray;
                }
                ;
                var schoolPosts = [];
                for (var j in posts) {
                    //if (userIds.includes(posts[j].author.id)) {
                    if (inArray(userIds, posts[j].author.id)) {
                        schoolPosts.push(posts[j]);
                    }
                    ;
                }
                ;
                results['posts'] = schoolPosts;
                results['school'] = schoolId;
                results['count'] = schoolPosts.length;
                results['count_total'] = schoolPosts.length;
                _listPromise.resolve(results);
            });
        });
        return _listPromise.promise;
    };
    ProductsService.prototype.getProductsBySubcategory0 = function (subcategory0Id, page) {
        return this.db.query('core/get_tag_posts');
    };
    ProductsService.prototype.getProductsBySubcategory1 = function (subcategory1Id, page) {
        return this.db.query('core/get_tag_posts');
    };
    ProductsService.prototype.getProductsByStyle = function (styleId, page) {
        return this.db.query('core/get_tag_posts');
    };
    ProductsService.prototype.createProduct = function (nonce, author, title, content, status, categories, tags) {
        return this.db.query('posts/create_post/?nonce=' + nonce + '&author=' + author + '&title=' + title + '&content=' + content + '&status=' + status + '&categories=' + categories + '&tags=' + tags);
    };
    ProductsService.prototype.updateProduct = function (nonce, productId, author, title, content, status, categories, tags) {
        return this.db.query('posts/update_post/?nonce=' + nonce + '&id=' + productId + '&author=' + author + '&title=' + title + '&content=' + content + '&status=' + status + '&categories=' + categories + '&tags=' + tags);
    };
    ProductsService.prototype.deleteProduct = function (nonce, productId) {
        return this.db.query('posts/delete_post/?nonce=' + nonce + '&id=' + productId);
    };
    ProductsService.prototype.createComment = function (productId, cookie, content) {
        return this.db.query('user/post_comment/?post_id=' + productId + '&cookie=' + cookie + '&comment_status=1' + '&content=' + content);
    };
    return ProductsService;
})();
exports.ProductsService = ProductsService;
;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZHVsZXMvcHJvZHVjdHMvcHJvZHVjdHMuc2VydmljZS50cyJdLCJuYW1lcyI6WyJQcm9kdWN0c1NlcnZpY2UiLCJQcm9kdWN0c1NlcnZpY2UuY29uc3RydWN0b3IiLCJQcm9kdWN0c1NlcnZpY2UuZ2V0UHJvZHVjdHNOZXciLCJQcm9kdWN0c1NlcnZpY2UuZ2V0UHJvZHVjdHNMaXN0IiwiUHJvZHVjdHNTZXJ2aWNlLmdldFByb2R1Y3RCeUlkIiwiUHJvZHVjdHNTZXJ2aWNlLmdldFByb2R1Y3RzQnlBdXRob3IiLCJQcm9kdWN0c1NlcnZpY2UuZ2V0UHJvZHVjdHNCeUNhdGVnb3J5IiwiUHJvZHVjdHNTZXJ2aWNlLmdldFByb2R1Y3RzQnlUYWciLCJQcm9kdWN0c1NlcnZpY2UuZ2V0UHJvZHVjdHNCeVNjaG9vbCIsIlByb2R1Y3RzU2VydmljZS5nZXRQcm9kdWN0c0J5U2Nob29sLmluQXJyYXkiLCJQcm9kdWN0c1NlcnZpY2UuZ2V0UHJvZHVjdHNCeVN1YmNhdGVnb3J5MCIsIlByb2R1Y3RzU2VydmljZS5nZXRQcm9kdWN0c0J5U3ViY2F0ZWdvcnkxIiwiUHJvZHVjdHNTZXJ2aWNlLmdldFByb2R1Y3RzQnlTdHlsZSIsIlByb2R1Y3RzU2VydmljZS5jcmVhdGVQcm9kdWN0IiwiUHJvZHVjdHNTZXJ2aWNlLnVwZGF0ZVByb2R1Y3QiLCJQcm9kdWN0c1NlcnZpY2UuZGVsZXRlUHJvZHVjdCIsIlByb2R1Y3RzU2VydmljZS5jcmVhdGVDb21tZW50Il0sIm1hcHBpbmdzIjoiQUFBQSxrREFBa0Q7QUFDbEQsNERBQTREO0FBRTVELElBQU8sQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDO0FBQ3hCLElBQU8sVUFBVSxXQUFXLGtDQUFrQyxDQUFDLENBQUE7QUF3Qi9ELElBQWEsZUFBZTtJQUE1QkEsU0FBYUEsZUFBZUE7UUFDaEJDLE9BQUVBLEdBQUdBLFVBQVVBLENBQUNBLE9BQU9BLENBQUNBO0lBZ0lwQ0EsQ0FBQ0E7SUE5SEdELHdDQUFjQSxHQUFkQSxVQUFl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ZXMvcHJvZHVjdHMvcHJvZHVjdHMuc2VydmljZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi8uLi90eXBpbmdzL3RzZC5kLnRzXCIgLz5cbi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi9jb25uZWN0aW9uL2Nvbm5lY3Rpb24uc2VydmljZS50c1wiIC8+XG5cbmltcG9ydCBRID0gcmVxdWlyZShcInFcIik7XG5pbXBvcnQgY29ubmVjdGlvbiA9IHJlcXVpcmUoJy4uL2Nvbm5lY3Rpb24vY29ubmVjdGlvbi5zZXJ2aWNlJylcblxuZXhwb3J0IGludGVyZmFjZSBJUHJvZHVjdHNTZXJ2aWNlIHtcbiAgICAvLyBHRVRcbiAgICBnZXRQcm9kdWN0c05ldyhwYWdlKTogUS5JUHJvbWlzZTx7fT47XG4gICAgZ2V0UHJvZHVjdHNMaXN0KHBhZ2UpOiBRLklQcm9taXNlPHt9PjtcbiAgICBnZXRQcm9kdWN0QnlJZChwcm9kdWN0SWQpOiBRLklQcm9taXNlPHt9PjtcbiAgICBnZXRQcm9kdWN0c0J5QXV0aG9yKGF1dGhvcklkLCBwYWdlKTogUS5JUHJvbWlzZTx7fT47XG4gICAgZ2V0UHJvZHVjdHNCeUNhdGVnb3J5KGNhdGVnb3J5SWQsIHBhZ2UpOiBRLklQcm9taXNlPHt9PjtcbiAgICBnZXRQcm9kdWN0c0J5VGFnKHRhZ0lkLCBwYWdlKTogUS5JUHJvbWlzZTx7fT47XG4gICAgZ2V0UHJvZHVjdHNCeVNjaG9vbChzY2hvb2xJZCwgcGFnZSk6IFEuSVByb21pc2U8e30+O1xuICAgIGdldFByb2R1Y3RzQnlTdWJjYXRlZ29yeTAoc3ViY2F0ZWdvcnkwSWQsIHBhZ2UpOiBRLklQcm9taXNlPHt9PjtcbiAgICBnZXRQcm9kdWN0c0J5U3ViY2F0ZWdvcnkxKHN1YmNhdGVnb3J5MUlkLCBwYWdlKTogUS5JUHJvbWlzZTx7fT47XG4gICAgZ2V0UHJvZHVjdHNCeVN0eWxlKHN0eWxlSWQsIHBhZ2UpOiBRLklQcm9taXNlPHt9PjtcbiAgICAvLyBQT1NUXG4gICAgY3JlYXRlUHJvZHVjdChub25jZSwgYXV0aG9yLCB0aXRsZSwgY29udGVudCwgc3RhdHVzLCBjYXRlZ29yaWVzLCB0YWdzKTogUS5JUHJvbWlzZTx7fT47XG4gICAgY3JlYXRlQ29tbWVudChwcm9kdWN0SWQsIGNvb2tpZSwgY29udGVudCk6IFEuSVByb21pc2U8e30+O1xuICAgIC8vIFBVVFxuICAgIHVwZGF0ZVByb2R1Y3Qobm9uY2UsIHByb2R1Y3RJZCwgYXV0aG9yLCB0aXRsZSwgY29udGVudCwgc3RhdHVzLCBjYXRlZ29yaWVzLCB0YWdzKTogUS5JUHJvbWlzZTx7fT47XG4gICAgLy8gREVMRVRFXG4gICAgZGVsZXRlUHJvZHVjdChub25jZSwgcHJvZHVjdElkKTogUS5JUHJvbWlzZTx7fT47XG59XG5cblxuZXhwb3J0IGNsYXNzIFByb2R1Y3RzU2VydmljZSBpbXBsZW1lbnRzIElQcm9kdWN0c1NlcnZpY2Uge1xuICAgIHByaXZhdGUgZGIgPSBjb25uZWN0aW9uLnNlcnZpY2U7XG5cbiAgICBnZXRQcm9kdWN0c05ldyhwYWdlKTogUS5JUHJvbWlzZTx7fT4ge1xuICAgICAgICB2YXIgX2xpc3RQcm9taXNlID0gUS5kZWZlcigpO1xuICAgICAgICB0aGlzLmRiLnF1ZXJ5KCdjb3JlLz9qc29uPWdldF9yZWNlbnRfcG9zdHMmY291bnQ9NCZwYWdlPScgKyBwYWdlKVxuICAgICAgICAgICAgLnRoZW4oKHJlc3VsdHMpID0+IHtcbiAgICAgICAgICAgICAgICBfbGlzdFByb21pc2UucmVzb2x2ZShyZXN1bHRzKTtcbiAgICAgICAgICAgIH0pXG5cbiAgICAgICAgcmV0dXJuIF9saXN0UHJvbWlzZS5wcm9taXNlO1xuICAgIH1cblxuICAgIGdldFByb2R1Y3RzTGlzdChwYWdlKTogUS5JUHJvbWlzZTx7fT4ge1xuICAgICAgICB2YXIgX2xpc3RQcm9taXNlID0gUS5kZWZlcigpO1xuICAgICAgICB0aGlzLmRiLnF1ZXJ5KCdjb3JlLz9qc29uPWdldF9wb3N0cyZjb3VudD00JnBhZ2U9JyArIHBhZ2UpXG4gICAgICAgICAgICAudGhlbigocmVzdWx0cykgPT4ge1xuICAgICAgICAgICAgICAgIF9saXN0UHJvbWlzZS5yZXNvbHZlKHJlc3VsdHMpO1xuICAgICAgICAgICAgfSlcblxuICAgICAgICByZXR1cm4gX2xpc3RQcm9taXNlLnByb21pc2U7XG4gICAgfVxuXG4gICAgZ2V0UHJvZHVjdEJ5SWQocHJvZHVjdElkKTogUS5JUHJvbWlzZTx7fT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5kYi5xdWVyeSgnY29yZS9nZXRfcG9zdC8/aWQ9JyArIHByb2R1Y3RJZClcbiAgICB9XG5cbiAgICBnZXRQcm9kdWN0c0J5QXV0aG9yKGF1dGhvcklkLCBwYWdlKTogUS5JUHJvbWlzZTx7fT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5kYi5xdWVyeSgnY29yZS9nZXRfYXV0aG9yX3Bvc3RzLz9jb3VudD00JmlkPScgKyBhdXRob3JJZCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICcmcGFnZT0nICsgcGFnZSlcbiAgICB9XG5cbiAgICBnZXRQcm9kdWN0c0J5Q2F0ZWdvcnkoY2F0ZWdvcnlJZCwgcGFnZSk6IFEuSVByb21pc2U8e30+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIucXVlcnkoJ2NvcmUvZ2V0X2NhdGVnb3J5X3Bvc3RzLz9jb3VudD00JmlkPScgKyBjYXRlZ29yeUlkICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyZwYWdlPScgKyBwYWdlKVxuICAgIH1cblxuICAgIGdldFByb2R1Y3RzQnlUYWcodGFnSWQsIHBhZ2UpOiBRLklQcm9taXNlPHt9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmRiLnF1ZXJ5KCdjb3JlL2dldF90YWdfcG9zdHMvP2NvdW50PTQmaWQ9JyArIHRhZ0lkICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyZwYWdlPScgKyBwYWdlKVxuICAgIH1cblxuICAgIGdldFByb2R1Y3RzQnlTY2hvb2woc2Nob29sSWQsIHBhZ2UpOiBRLklQcm9taXNlPHt9PiB7XG4gICAgICAgIHZhciBfbGlzdFByb21pc2UgPSBRLmRlZmVyKCk7XG4gICAgICAgIHRoaXMuZGIucXVlcnkoJ2NvcmUvP2pzb249Z2V0X3Bvc3RzJmNvdW50PTIwMCcpXG4gICAgICAgICAgICAudGhlbigocmVzdWx0cykgPT4ge1xuICAgICAgICAgICAgICAgIHZhciBwb3N0cyA9IHJlc3VsdHNbJ3Bvc3RzJ107XG5cbiAgICAgICAgICAgICAgICB0aGlzLmRiLnF1ZXJ5X2RiKFwiU0VMRUNUIHVzZXJfaWQgRlJPTSB3cDJfYnBfeHByb2ZpbGVfZGF0YSBXSEVSRSB2YWx1ZT0nXCIgKyBzY2hvb2xJZCArIFwiJyBBTkQgZmllbGRfaWQ9NFwiKVxuICAgICAgICAgICAgICAgICAgICAudGhlbigoZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHVzZXJJZHMgPSBbXVxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSBpbiBkYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlcklkcy5wdXNoKGRhdGFbaV0udXNlcl9pZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGluQXJyYXkobXlBcnJheSwgbXlWYWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpbkFycmF5ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbXlBcnJheS5tYXAoZnVuY3Rpb24oa2V5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrZXkgPT09IG15VmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluQXJyYXkgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGluQXJyYXk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2Nob29sUG9zdHMgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGogaW4gcG9zdHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL2lmICh1c2VySWRzLmluY2x1ZGVzKHBvc3RzW2pdLmF1dGhvci5pZCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5BcnJheSh1c2VySWRzLCBwb3N0c1tqXS5hdXRob3IuaWQpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjaG9vbFBvc3RzLnB1c2gocG9zdHNbal0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0c1sncG9zdHMnXSA9IHNjaG9vbFBvc3RzO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0c1snc2Nob29sJ10gPSBzY2hvb2xJZDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHNbJ2NvdW50J10gPSBzY2hvb2xQb3N0cy5sZW5ndGg7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzWydjb3VudF90b3RhbCddID0gc2Nob29sUG9zdHMubGVuZ3RoO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBfbGlzdFByb21pc2UucmVzb2x2ZShyZXN1bHRzKTtcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pXG5cbiAgICAgICAgcmV0dXJuIF9saXN0UHJvbWlzZS5wcm9taXNlO1xuICAgIH1cblxuICAgIGdldFByb2R1Y3RzQnlTdWJjYXRlZ29yeTAoc3ViY2F0ZWdvcnkwSWQsIHBhZ2UpOiBRLklQcm9taXNlPHt9PiDCoHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIucXVlcnkoJ2NvcmUvZ2V0X3RhZ19wb3N0cycpXG4gICAgfVxuXG4gICAgZ2V0UHJvZHVjdHNCeVN1YmNhdGVnb3J5MShzdWJjYXRlZ29yeTFJZCwgcGFnZSk6IFEuSVByb21pc2U8e30+IMKge1xuICAgICAgICByZXR1cm4gdGhpcy5kYi5xdWVyeSgnY29yZS9nZXRfdGFnX3Bvc3RzJylcbiAgICB9XG5cbiAgICBnZXRQcm9kdWN0c0J5U3R5bGUoc3R5bGVJZCwgcGFnZSk6IFEuSVByb21pc2U8e30+IMKge1xuICAgICAgICByZXR1cm4gdGhpcy5kYi5xdWVyeSgnY29yZS9nZXRfdGFnX3Bvc3RzJylcbiAgICB9XG5cbiAgICBjcmVhdGVQcm9kdWN0KG5vbmNlLCBhdXRob3IsIHRpdGxlLCBjb250ZW50LCBzdGF0dXMsIGNhdGVnb3JpZXMsIHRhZ3MpOiBRLklQcm9taXNlPHt9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmRiLnF1ZXJ5KCdwb3N0cy9jcmVhdGVfcG9zdC8/bm9uY2U9JyArIG5vbmNlICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyZhdXRob3I9JyArIGF1dGhvciArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICcmdGl0bGU9JyArIHRpdGxlICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyZjb250ZW50PScgKyBjb250ZW50ICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyZzdGF0dXM9JyArIHN0YXR1cyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICcmY2F0ZWdvcmllcz0nICsgY2F0ZWdvcmllcyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICcmdGFncz0nICsgdGFncylcbiAgICB9XG5cbiAgICB1cGRhdGVQcm9kdWN0KG5vbmNlLCBwcm9kdWN0SWQsIGF1dGhvciwgdGl0bGUsIGNvbnRlbnQsIHN0YXR1cywgY2F0ZWdvcmllcywgdGFncyk6IFEuSVByb21pc2U8e30+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIucXVlcnkoJ3Bvc3RzL3VwZGF0ZV9wb3N0Lz9ub25jZT0nICsgbm9uY2UgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnJmlkPScgKyBwcm9kdWN0SWQgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnJmF1dGhvcj0nICsgYXV0aG9yICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyZ0aXRsZT0nICsgdGl0bGUgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnJmNvbnRlbnQ9JyArIGNvbnRlbnQgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnJnN0YXR1cz0nICsgc3RhdHVzICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyZjYXRlZ29yaWVzPScgKyBjYXRlZ29yaWVzICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyZ0YWdzPScgKyB0YWdzKVxuICAgIH1cblxuICAgIGRlbGV0ZVByb2R1Y3Qobm9uY2UsIHByb2R1Y3RJZCk6IFEuSVByb21pc2U8e30+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIucXVlcnkoJ3Bvc3RzL2RlbGV0ZV9wb3N0Lz9ub25jZT0nICsgbm9uY2UgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnJmlkPScgKyBwcm9kdWN0SWQpXG4gICAgfVxuXG4gICAgY3JlYXRlQ29tbWVudChwcm9kdWN0SWQsIGNvb2tpZSwgY29udGVudCk6IFEuSVByb21pc2U8e30+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIucXVlcnkoJ3VzZXIvcG9zdF9jb21tZW50Lz9wb3N0X2lkPScgKyBwcm9kdWN0SWQgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnJmNvb2tpZT0nICsgY29va2llICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyZjb21tZW50X3N0YXR1cz0xJyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICcmY29udGVudD0nICsgY29udGVudClcbiAgICB9XG5cbn07XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=