/// <reference path="../../../typings/tsd.d.ts" />
/// <reference path="../connection/connection.service.ts" />
var Q = require("q");
var connection = require('../connection/connection.service');
var inArray = function (myArray, myValue) {
    var inArray = false;
    myArray.map(function (key) {
        if (key === myValue) {
            inArray = true;
        }
    });
    return inArray;
};
var ProductsService = (function () {
    function ProductsService() {
        this.db = connection.service;
    }
    ProductsService.prototype.getProductsNew = function (page) {
        var _listPromise = Q.defer();
        this.db.query('core/?json=get_recent_posts&count=4&page=' + page).then(function (results) {
            _listPromise.resolve(results);
        });
        return _listPromise.promise;
    };
    ProductsService.prototype.getProductsList = function (page) {
        var _listPromise = Q.defer();
        this.db.query('core/?json=get_posts&count=4&page=' + page).then(function (results) {
            _listPromise.resolve(results);
        });
        return _listPromise.promise;
    };
    ProductsService.prototype.getProductById = function (productId, userId) {
        var _this = this;
        return this.db.query('core/get_post/?id=' + productId).then(function (result) {
            // save visit if is logued in
            if (userId !== 'null') {
                return _this.db.query_db("INSERT INTO wp2_postmeta (meta_id, post_id, meta_key, meta_value) VALUES (NULL," + productId + ",'visit','" + userId + "')").then(function () {
                    return result;
                });
            }
            ;
        });
    };
    ProductsService.prototype.getProductsByAuthor = function (authorId, page) {
        return this.db.query('core/get_author_posts/?count=4&id=' + authorId + '&page=' + page);
    };
    ProductsService.prototype.getProductsByCategory = function (categoryId, page) {
        return this.db.query('core/get_category_posts/?count=4&id=' + categoryId + '&page=' + page);
    };
    ProductsService.prototype.getProductsByTag = function (tagId, page) {
        return this.db.query('core/get_tag_posts/?count=4&id=' + tagId + '&page=' + page);
    };
    ProductsService.prototype.getProductsBySchool = function (schoolId, page) {
        var _this = this;
        var _listPromise = Q.defer();
        this.db.query('core/?json=get_posts&count=200').then(function (results) {
            var posts = results['posts'];
            _this.db.query_db("SELECT user_id FROM wp2_bp_xprofile_data WHERE value='" + schoolId + "' AND field_id=4").then(function (data) {
                var userIds = [];
                for (var i in data) {
                    userIds.push(data[i].user_id);
                }
                var schoolPosts = [];
                for (var j in posts) {
                    if (inArray(userIds, posts[j].author.id)) {
                        schoolPosts.push(posts[j]);
                    }
                    ;
                }
                ;
                results['posts'] = schoolPosts;
                results['school'] = schoolId;
                results['count'] = schoolPosts.length;
                results['count_total'] = schoolPosts.length;
                _listPromise.resolve(results);
            });
        });
        return _listPromise.promise;
    };
    ProductsService.prototype.getProductsBySubcategory0 = function (subcategory0Id, page) {
        var _listPromise = Q.defer();
        this.db.query('core/?json=get_posts&count=200').then(function (results) {
            var posts = results['posts'];
            var subcategory0Posts = [];
            for (var i in posts) {
                if (posts[i]['custom_fields']['sofbackend__sof_work_meta__category_0'] == subcategory0Id) {
                    subcategory0Posts.push(posts[i]);
                }
                ;
            }
            ;
            results['posts'] = subcategory0Posts;
            results['subcategory0'] = subcategory0Id;
            results['count'] = subcategory0Posts.length;
            results['count_total'] = subcategory0Posts.length;
            _listPromise.resolve(results);
        });
        return _listPromise.promise;
    };
    ProductsService.prototype.getProductsBySubcategory1 = function (subcategory1Id, page) {
        var _listPromise = Q.defer();
        this.db.query('core/?json=get_posts&count=200').then(function (results) {
            var posts = results['posts'];
            var subcategory1Posts = [];
            for (var i in posts) {
                if (posts[i]['custom_fields']['sofbackend__sof_work_meta__category_0'] == subcategory1Id) {
                    subcategory1Posts.push(posts[i]);
                }
                ;
            }
            ;
            results['posts'] = subcategory1Posts;
            results['subcategory0'] = subcategory1Id;
            results['count'] = subcategory1Posts.length;
            results['count_total'] = subcategory1Posts.length;
            _listPromise.resolve(results);
        });
        return _listPromise.promise;
    };
    ProductsService.prototype.getProductsByStyle = function (styleId, page) {
        var _listPromise = Q.defer();
        this.db.query('core/?json=get_posts&count=200').then(function (results) {
            var posts = results['posts'];
            var stylePosts = [];
            for (var i in posts) {
                if (posts[i]['custom_fields']['sofbackend__sof_work_meta__category_0'] == styleId) {
                    stylePosts.push(posts[i]);
                }
                ;
            }
            ;
            results['posts'] = stylePosts;
            results['subcategory0'] = styleId;
            results['count'] = stylePosts.length;
            results['count_total'] = stylePosts.length;
            _listPromise.resolve(results);
        });
        return _listPromise.promise;
    };
    ProductsService.prototype.createProduct = function (nonce, author, title, content, status, school, subcategory0, subcategory1, styles) {
        return this.db.query('posts/create_post/?nonce=' + nonce + '&author=' + author + '&title=' + title + '&content=' + content + '&status=' + status).then(function (post) {
            console.log(post);
            // FALTA GUARDAR SCHOOL, SUBCATEGORY, STYLES
            return post;
        });
    };
    ProductsService.prototype.updateProduct = function (nonce, productId, author, title, content, status, categories, tags) {
        return this.db.query('posts/update_post/?nonce=' + nonce + '&id=' + productId + '&author=' + author + '&title=' + title + '&content=' + content + '&status=' + status + '&categories=' + categories + '&tags=' + tags);
    };
    ProductsService.prototype.deleteProduct = function (nonce, productId) {
        return this.db.query('posts/delete_post/?nonce=' + nonce + '&id=' + productId);
    };
    ProductsService.prototype.createComment = function (productId, cookie, content) {
        return this.db.query('user/post_comment/?post_id=' + productId + '&cookie=' + cookie + '&comment_status=1' + '&content=' + content);
    };
    ProductsService.prototype.getProductsBySearch = function (search, page) {
        return this.db.query('core/get_search_results/?count=4&search=' + search + '&page=' + page);
    };
    return ProductsService;
})();
exports.ProductsService = ProductsService;
;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZHVsZXMvcHJvZHVjdHMvcHJvZHVjdHMuc2VydmljZS50cyJdLCJuYW1lcyI6WyJQcm9kdWN0c1NlcnZpY2UiLCJQcm9kdWN0c1NlcnZpY2UuY29uc3RydWN0b3IiLCJQcm9kdWN0c1NlcnZpY2UuZ2V0UHJvZHVjdHNOZXciLCJQcm9kdWN0c1NlcnZpY2UuZ2V0UHJvZHVjdHNMaXN0IiwiUHJvZHVjdHNTZXJ2aWNlLmdldFByb2R1Y3RCeUlkIiwiUHJvZHVjdHNTZXJ2aWNlLmdldFByb2R1Y3RzQnlBdXRob3IiLCJQcm9kdWN0c1NlcnZpY2UuZ2V0UHJvZHVjdHNCeUNhdGVnb3J5IiwiUHJvZHVjdHNTZXJ2aWNlLmdldFByb2R1Y3RzQnlUYWciLCJQcm9kdWN0c1NlcnZpY2UuZ2V0UHJvZHVjdHNCeVNjaG9vbCIsIlByb2R1Y3RzU2VydmljZS5nZXRQcm9kdWN0c0J5U3ViY2F0ZWdvcnkwIiwiUHJvZHVjdHNTZXJ2aWNlLmdldFByb2R1Y3RzQnlTdWJjYXRlZ29yeTEiLCJQcm9kdWN0c1NlcnZpY2UuZ2V0UHJvZHVjdHNCeVN0eWxlIiwiUHJvZHVjdHNTZXJ2aWNlLmNyZWF0ZVByb2R1Y3QiLCJQcm9kdWN0c1NlcnZpY2UudXBkYXRlUHJvZHVjdCIsIlByb2R1Y3RzU2VydmljZS5kZWxldGVQcm9kdWN0IiwiUHJvZHVjdHNTZXJ2aWNlLmNyZWF0ZUNvbW1lbnQiLCJQcm9kdWN0c1NlcnZpY2UuZ2V0UHJvZHVjdHNCeVNlYXJjaCJdLCJtYXBwaW5ncyI6IkFBQUEsa0RBQWtEO0FBQ2xELDREQUE0RDtBQUU1RCxJQUFPLENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQztBQUN4QixJQUFPLFVBQVUsV0FBVyxrQ0FBa0MsQ0FBQyxDQUFBO0FBd0IvRCxJQUFJLE9BQU8sR0FBRyxVQUFTLE9BQU8sRUFBRSxPQUFPO0lBQ25DLElBQUksT0FBTyxHQUFHLEtBQUssQ0FBQztJQUNwQixPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVMsR0FBRztRQUNwQixFQUFFLENBQUMs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R0FDbkJBLG1CQUFtQkEsR0FDbkJBLFdBQVdBLEdBQUdBLE9BQU9BLENBQUNBLENBQUFBO0lBQy9DQSxDQUFDQTtJQUVEZiw2Q0FBbUJBLEdBQW5CQSxVQUFvQkEsTUFBTUEsRUFBRUEsSUFBSUE7UUFDNUJnQixNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxLQUFLQSxDQUFDQSwwQ0FBMENBLEdBQUdBLE1BQU1BLEdBQ3BFQSxRQUFRQSxHQUFHQSxJQUFJQSxDQUFDQSxDQUFBQTtJQUN4QkEsQ0FBQ0E7SUFFTGhCLHNCQUFDQTtBQUFEQSxDQXBNQSxBQW9NQ0EsSUFBQTtBQXBNWSx1QkFBZSxHQUFmLGVBb01aLENBQUE7QUFBQSxDQUFDIiwiZmlsZSI6Im1vZHVsZXMvcHJvZHVjdHMvcHJvZHVjdHMuc2VydmljZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi8uLi8uLi90eXBpbmdzL3RzZC5kLnRzXCIgLz5cbi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi9jb25uZWN0aW9uL2Nvbm5lY3Rpb24uc2VydmljZS50c1wiIC8+XG5cbmltcG9ydCBRID0gcmVxdWlyZShcInFcIik7XG5pbXBvcnQgY29ubmVjdGlvbiA9IHJlcXVpcmUoJy4uL2Nvbm5lY3Rpb24vY29ubmVjdGlvbi5zZXJ2aWNlJylcblxuZXhwb3J0IGludGVyZmFjZSBJUHJvZHVjdHNTZXJ2aWNlIHtcbiAgICAvLyBHRVRcbiAgICBnZXRQcm9kdWN0c05ldyhwYWdlKTogUS5JUHJvbWlzZTx7fT47XG4gICAgZ2V0UHJvZHVjdHNMaXN0KHBhZ2UpOiBRLklQcm9taXNlPHt9PjtcbiAgICBnZXRQcm9kdWN0QnlJZChwcm9kdWN0SWQsIHVzZXJJZCk6IFEuSVByb21pc2U8e30+O1xuICAgIGdldFByb2R1Y3RzQnlBdXRob3IoYXV0aG9ySWQsIHBhZ2UpOiBRLklQcm9taXNlPHt9PjtcbiAgICBnZXRQcm9kdWN0c0J5Q2F0ZWdvcnkoY2F0ZWdvcnlJZCwgcGFnZSk6IFEuSVByb21pc2U8e30+O1xuICAgIGdldFByb2R1Y3RzQnlUYWcodGFnSWQsIHBhZ2UpOiBRLklQcm9taXNlPHt9PjtcbiAgICBnZXRQcm9kdWN0c0J5U2Nob29sKHNjaG9vbElkLCBwYWdlKTogUS5JUHJvbWlzZTx7fT47XG4gICAgZ2V0UHJvZHVjdHNCeVN1YmNhdGVnb3J5MChzdWJjYXRlZ29yeTBJZCwgcGFnZSk6IFEuSVByb21pc2U8e30+O1xuICAgIGdldFByb2R1Y3RzQnlTdWJjYXRlZ29yeTEoc3ViY2F0ZWdvcnkxSWQsIHBhZ2UpOiBRLklQcm9taXNlPHt9PjtcbiAgICBnZXRQcm9kdWN0c0J5U3R5bGUoc3R5bGVJZCwgcGFnZSk6IFEuSVByb21pc2U8e30+O1xuICAgIGdldFByb2R1Y3RzQnlTZWFyY2goc2VhcmNoLCBwYWdlKTogUS5JUHJvbWlzZTx7fT47XG4gICAgLy8gUE9TVFxuICAgIGNyZWF0ZVByb2R1Y3Qobm9uY2UsIGF1dGhvciwgdGl0bGUsIGNvbnRlbnQsIHN0YXR1cywgc2Nob29sLCBzdWJjYXRlZ29yeTAsIHN1YmNhdGVnb3J5MSwgc3R5bGVzKTogUS5JUHJvbWlzZTx7fT47XG4gICAgY3JlYXRlQ29tbWVudChwcm9kdWN0SWQsIGNvb2tpZSwgY29udGVudCk6IFEuSVByb21pc2U8e30+O1xuICAgIC8vIFBVVFxuICAgIHVwZGF0ZVByb2R1Y3Qobm9uY2UsIHByb2R1Y3RJZCwgYXV0aG9yLCB0aXRsZSwgY29udGVudCwgc3RhdHVzLCBjYXRlZ29yaWVzLCB0YWdzKTogUS5JUHJvbWlzZTx7fT47XG4gICAgLy8gREVMRVRFXG4gICAgZGVsZXRlUHJvZHVjdChub25jZSwgcHJvZHVjdElkKTogUS5JUHJvbWlzZTx7fT47XG59XG5cbnZhciBpbkFycmF5ID0gZnVuY3Rpb24obXlBcnJheSwgbXlWYWx1ZSkge1xuICAgIHZhciBpbkFycmF5ID0gZmFsc2U7XG4gICAgbXlBcnJheS5tYXAoZnVuY3Rpb24oa2V5KSB7XG4gICAgICAgIGlmIChrZXkgPT09IG15VmFsdWUpIHtcbiAgICAgICAgICAgIGluQXJyYXkgPSB0cnVlO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIGluQXJyYXk7XG59O1xuXG5leHBvcnQgY2xhc3MgUHJvZHVjdHNTZXJ2aWNlIGltcGxlbWVudHMgSVByb2R1Y3RzU2VydmljZSB7XG4gICAgcHJpdmF0ZSBkYiA9IGNvbm5lY3Rpb24uc2VydmljZTtcblxuICAgIGdldFByb2R1Y3RzTmV3KHBhZ2UpOiBRLklQcm9taXNlPHt9PiB7XG4gICAgICAgIHZhciBfbGlzdFByb21pc2UgPSBRLmRlZmVyKCk7XG4gICAgICAgIHRoaXMuZGIucXVlcnkoJ2NvcmUvP2pzb249Z2V0X3JlY2VudF9wb3N0cyZjb3VudD00JnBhZ2U9JyArIHBhZ2UpXG4gICAgICAgICAgICAudGhlbigocmVzdWx0cykgPT4ge1xuICAgICAgICAgICAgICAgIF9saXN0UHJvbWlzZS5yZXNvbHZlKHJlc3VsdHMpO1xuICAgICAgICAgICAgfSlcblxuICAgICAgICByZXR1cm4gX2xpc3RQcm9taXNlLnByb21pc2U7XG4gICAgfVxuXG4gICAgZ2V0UHJvZHVjdHNMaXN0KHBhZ2UpOiBRLklQcm9taXNlPHt9PiB7XG4gICAgICAgIHZhciBfbGlzdFByb21pc2UgPSBRLmRlZmVyKCk7XG4gICAgICAgIHRoaXMuZGIucXVlcnkoJ2NvcmUvP2pzb249Z2V0X3Bvc3RzJmNvdW50PTQmcGFnZT0nICsgcGFnZSlcbiAgICAgICAgICAgIC50aGVuKChyZXN1bHRzKSA9PiB7XG4gICAgICAgICAgICAgICAgX2xpc3RQcm9taXNlLnJlc29sdmUocmVzdWx0cyk7XG4gICAgICAgICAgICB9KVxuXG4gICAgICAgIHJldHVybiBfbGlzdFByb21pc2UucHJvbWlzZTtcbiAgICB9XG5cbiAgICBnZXRQcm9kdWN0QnlJZChwcm9kdWN0SWQsIHVzZXJJZCk6IFEuSVByb21pc2U8e30+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIucXVlcnkoJ2NvcmUvZ2V0X3Bvc3QvP2lkPScgKyBwcm9kdWN0SWQpXG4gICAgICAgICAgICAudGhlbigocmVzdWx0KSA9PiB7XG4gICAgICAgICAgICAgICAgLy8gc2F2ZSB2aXNpdCBpZiBpcyBsb2d1ZWQgaW5cbiAgICAgICAgICAgICAgICBpZiAodXNlcklkICE9PSAnbnVsbCcpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGIucXVlcnlfZGIoXCJJTlNFUlQgSU5UTyB3cDJfcG9zdG1ldGEgKG1ldGFfaWQsIHBvc3RfaWQsIG1ldGFfa2V5LCBtZXRhX3ZhbHVlKSBWQUxVRVMgKE5VTEwsXCIgKyBwcm9kdWN0SWQgKyBcIiwndmlzaXQnLCdcIiArIHVzZXJJZCArIFwiJylcIilcbiAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSlcbiAgICB9XG5cbiAgICBnZXRQcm9kdWN0c0J5QXV0aG9yKGF1dGhvcklkLCBwYWdlKTogUS5JUHJvbWlzZTx7fT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5kYi5xdWVyeSgnY29yZS9nZXRfYXV0aG9yX3Bvc3RzLz9jb3VudD00JmlkPScgKyBhdXRob3JJZCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICcmcGFnZT0nICsgcGFnZSlcbiAgICB9XG5cbiAgICBnZXRQcm9kdWN0c0J5Q2F0ZWdvcnkoY2F0ZWdvcnlJZCwgcGFnZSk6IFEuSVByb21pc2U8e30+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIucXVlcnkoJ2NvcmUvZ2V0X2NhdGVnb3J5X3Bvc3RzLz9jb3VudD00JmlkPScgKyBjYXRlZ29yeUlkICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyZwYWdlPScgKyBwYWdlKVxuICAgIH1cblxuICAgIGdldFByb2R1Y3RzQnlUYWcodGFnSWQsIHBhZ2UpOiBRLklQcm9taXNlPHt9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmRiLnF1ZXJ5KCdjb3JlL2dldF90YWdfcG9zdHMvP2NvdW50PTQmaWQ9JyArIHRhZ0lkICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyZwYWdlPScgKyBwYWdlKVxuICAgIH1cblxuICAgIGdldFByb2R1Y3RzQnlTY2hvb2woc2Nob29sSWQsIHBhZ2UpOiBRLklQcm9taXNlPHt9PiB7XG4gICAgICAgIHZhciBfbGlzdFByb21pc2UgPSBRLmRlZmVyKCk7XG4gICAgICAgIHRoaXMuZGIucXVlcnkoJ2NvcmUvP2pzb249Z2V0X3Bvc3RzJmNvdW50PTIwMCcpXG4gICAgICAgICAgICAudGhlbigocmVzdWx0cykgPT4ge1xuICAgICAgICAgICAgICAgIHZhciBwb3N0cyA9IHJlc3VsdHNbJ3Bvc3RzJ107XG5cbiAgICAgICAgICAgICAgICB0aGlzLmRiLnF1ZXJ5X2RiKFwiU0VMRUNUIHVzZXJfaWQgRlJPTSB3cDJfYnBfeHByb2ZpbGVfZGF0YSBXSEVSRSB2YWx1ZT0nXCIgKyBzY2hvb2xJZCArIFwiJyBBTkQgZmllbGRfaWQ9NFwiKVxuICAgICAgICAgICAgICAgICAgICAudGhlbigoZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHVzZXJJZHMgPSBbXVxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSBpbiBkYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlcklkcy5wdXNoKGRhdGFbaV0udXNlcl9pZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzY2hvb2xQb3N0cyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaiBpbiBwb3N0cykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbkFycmF5KHVzZXJJZHMsIHBvc3RzW2pdLmF1dGhvci5pZCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Nob29sUG9zdHMucHVzaChwb3N0c1tqXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzWydwb3N0cyddID0gc2Nob29sUG9zdHM7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzWydzY2hvb2wnXSA9IHNjaG9vbElkO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0c1snY291bnQnXSA9IHNjaG9vbFBvc3RzLmxlbmd0aDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHNbJ2NvdW50X3RvdGFsJ10gPSBzY2hvb2xQb3N0cy5sZW5ndGg7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIF9saXN0UHJvbWlzZS5yZXNvbHZlKHJlc3VsdHMpO1xuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSlcbiAgICAgICAgcmV0dXJuIF9saXN0UHJvbWlzZS5wcm9taXNlO1xuICAgIH1cblxuICAgIGdldFByb2R1Y3RzQnlTdWJjYXRlZ29yeTAoc3ViY2F0ZWdvcnkwSWQsIHBhZ2UpOiBRLklQcm9taXNlPHt9PiDCoHtcbiAgICAgICAgdmFyIF9saXN0UHJvbWlzZSA9IFEuZGVmZXIoKTtcbiAgICAgICAgdGhpcy5kYi5xdWVyeSgnY29yZS8/anNvbj1nZXRfcG9zdHMmY291bnQ9MjAwJylcbiAgICAgICAgICAgIC50aGVuKChyZXN1bHRzKSA9PiB7XG4gICAgICAgICAgICAgICAgdmFyIHBvc3RzID0gcmVzdWx0c1sncG9zdHMnXTtcblxuICAgICAgICAgICAgICAgIHZhciBzdWJjYXRlZ29yeTBQb3N0cyA9IFtdO1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgaW4gcG9zdHMpIHtcblxuICAgICAgICAgICAgICAgICAgICBpZiAocG9zdHNbaV1bJ2N1c3RvbV9maWVsZHMnXVsnc29mYmFja2VuZF9fc29mX3dvcmtfbWV0YV9fY2F0ZWdvcnlfMCddID09IHN1YmNhdGVnb3J5MElkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdWJjYXRlZ29yeTBQb3N0cy5wdXNoKHBvc3RzW2ldKTtcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgcmVzdWx0c1sncG9zdHMnXSA9IHN1YmNhdGVnb3J5MFBvc3RzO1xuICAgICAgICAgICAgICAgIHJlc3VsdHNbJ3N1YmNhdGVnb3J5MCddID0gc3ViY2F0ZWdvcnkwSWQ7XG4gICAgICAgICAgICAgICAgcmVzdWx0c1snY291bnQnXSA9IHN1YmNhdGVnb3J5MFBvc3RzLmxlbmd0aDtcbiAgICAgICAgICAgICAgICByZXN1bHRzWydjb3VudF90b3RhbCddID0gc3ViY2F0ZWdvcnkwUG9zdHMubGVuZ3RoO1xuXG4gICAgICAgICAgICAgICAgX2xpc3RQcm9taXNlLnJlc29sdmUocmVzdWx0cyk7XG4gICAgICAgICAgICB9KVxuICAgICAgICByZXR1cm4gX2xpc3RQcm9taXNlLnByb21pc2U7XG4gICAgfVxuXG4gICAgZ2V0UHJvZHVjdHNCeVN1YmNhdGVnb3J5MShzdWJjYXRlZ29yeTFJZCwgcGFnZSk6IFEuSVByb21pc2U8e30+IMKge1xuICAgICAgICB2YXIgX2xpc3RQcm9taXNlID0gUS5kZWZlcigpO1xuICAgICAgICB0aGlzLmRiLnF1ZXJ5KCdjb3JlLz9qc29uPWdldF9wb3N0cyZjb3VudD0yMDAnKVxuICAgICAgICAgICAgLnRoZW4oKHJlc3VsdHMpID0+IHtcbiAgICAgICAgICAgICAgICB2YXIgcG9zdHMgPSByZXN1bHRzWydwb3N0cyddO1xuXG4gICAgICAgICAgICAgICAgdmFyIHN1YmNhdGVnb3J5MVBvc3RzID0gW107XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSBpbiBwb3N0cykge1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChwb3N0c1tpXVsnY3VzdG9tX2ZpZWxkcyddWydzb2ZiYWNrZW5kX19zb2Zfd29ya19tZXRhX19jYXRlZ29yeV8wJ10gPT0gc3ViY2F0ZWdvcnkxSWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1YmNhdGVnb3J5MVBvc3RzLnB1c2gocG9zdHNbaV0pO1xuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICByZXN1bHRzWydwb3N0cyddID0gc3ViY2F0ZWdvcnkxUG9zdHM7XG4gICAgICAgICAgICAgICAgcmVzdWx0c1snc3ViY2F0ZWdvcnkwJ10gPSBzdWJjYXRlZ29yeTFJZDtcbiAgICAgICAgICAgICAgICByZXN1bHRzWydjb3VudCddID0gc3ViY2F0ZWdvcnkxUG9zdHMubGVuZ3RoO1xuICAgICAgICAgICAgICAgIHJlc3VsdHNbJ2NvdW50X3RvdGFsJ10gPSBzdWJjYXRlZ29yeTFQb3N0cy5sZW5ndGg7XG5cbiAgICAgICAgICAgICAgICBfbGlzdFByb21pc2UucmVzb2x2ZShyZXN1bHRzKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgIHJldHVybiBfbGlzdFByb21pc2UucHJvbWlzZTtcbiAgICB9XG5cbiAgICBnZXRQcm9kdWN0c0J5U3R5bGUoc3R5bGVJZCwgcGFnZSk6IFEuSVByb21pc2U8e30+IMKge1xuICAgICAgICB2YXIgX2xpc3RQcm9taXNlID0gUS5kZWZlcigpO1xuICAgICAgICB0aGlzLmRiLnF1ZXJ5KCdjb3JlLz9qc29uPWdldF9wb3N0cyZjb3VudD0yMDAnKVxuICAgICAgICAgICAgLnRoZW4oKHJlc3VsdHMpID0+IHtcbiAgICAgICAgICAgICAgICB2YXIgcG9zdHMgPSByZXN1bHRzWydwb3N0cyddO1xuXG4gICAgICAgICAgICAgICAgdmFyIHN0eWxlUG9zdHMgPSBbXTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpIGluIHBvc3RzKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKHBvc3RzW2ldWydjdXN0b21fZmllbGRzJ11bJ3NvZmJhY2tlbmRfX3NvZl93b3JrX21ldGFfX2NhdGVnb3J5XzAnXSA9PSBzdHlsZUlkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdHlsZVBvc3RzLnB1c2gocG9zdHNbaV0pO1xuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgICAgICByZXN1bHRzWydwb3N0cyddID0gc3R5bGVQb3N0cztcbiAgICAgICAgICAgICAgICByZXN1bHRzWydzdWJjYXRlZ29yeTAnXSA9IHN0eWxlSWQ7XG4gICAgICAgICAgICAgICAgcmVzdWx0c1snY291bnQnXSA9IHN0eWxlUG9zdHMubGVuZ3RoO1xuICAgICAgICAgICAgICAgIHJlc3VsdHNbJ2NvdW50X3RvdGFsJ10gPSBzdHlsZVBvc3RzLmxlbmd0aDtcblxuICAgICAgICAgICAgICAgIF9saXN0UHJvbWlzZS5yZXNvbHZlKHJlc3VsdHMpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgcmV0dXJuIF9saXN0UHJvbWlzZS5wcm9taXNlO1xuICAgIH1cblxuICAgIGNyZWF0ZVByb2R1Y3Qobm9uY2UsIGF1dGhvciwgdGl0bGUsIGNvbnRlbnQsIHN0YXR1cywgc2Nob29sLCBzdWJjYXRlZ29yeTAsIHN1YmNhdGVnb3J5MSwgc3R5bGVzKTogUS5JUHJvbWlzZTx7fT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5kYi5xdWVyeSgncG9zdHMvY3JlYXRlX3Bvc3QvP25vbmNlPScgKyBub25jZSArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICcmYXV0aG9yPScgKyBhdXRob3IgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnJnRpdGxlPScgKyB0aXRsZSArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICcmY29udGVudD0nICsgY29udGVudCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICcmc3RhdHVzPScgKyBzdGF0dXMpXG4gICAgICAgICAgICAudGhlbigocG9zdCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHBvc3QpO1xuXG4gICAgICAgICAgICAgICAgLy8gRkFMVEEgR1VBUkRBUiBTQ0hPT0wsIFNVQkNBVEVHT1JZLCBTVFlMRVNcblxuICAgICAgICAgICAgICAgIHJldHVybiBwb3N0O1xuICAgICAgICAgICAgfSlcbiAgICB9XG5cbiAgICB1cGRhdGVQcm9kdWN0KG5vbmNlLCBwcm9kdWN0SWQsIGF1dGhvciwgdGl0bGUsIGNvbnRlbnQsIHN0YXR1cywgY2F0ZWdvcmllcywgdGFncyk6IFEuSVByb21pc2U8e30+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIucXVlcnkoJ3Bvc3RzL3VwZGF0ZV9wb3N0Lz9ub25jZT0nICsgbm9uY2UgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnJmlkPScgKyBwcm9kdWN0SWQgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnJmF1dGhvcj0nICsgYXV0aG9yICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyZ0aXRsZT0nICsgdGl0bGUgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnJmNvbnRlbnQ9JyArIGNvbnRlbnQgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnJnN0YXR1cz0nICsgc3RhdHVzICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyZjYXRlZ29yaWVzPScgKyBjYXRlZ29yaWVzICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyZ0YWdzPScgKyB0YWdzKVxuICAgIH1cblxuICAgIGRlbGV0ZVByb2R1Y3Qobm9uY2UsIHByb2R1Y3RJZCk6IFEuSVByb21pc2U8e30+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIucXVlcnkoJ3Bvc3RzL2RlbGV0ZV9wb3N0Lz9ub25jZT0nICsgbm9uY2UgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnJmlkPScgKyBwcm9kdWN0SWQpXG4gICAgfVxuXG4gICAgY3JlYXRlQ29tbWVudChwcm9kdWN0SWQsIGNvb2tpZSwgY29udGVudCk6IFEuSVByb21pc2U8e30+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIucXVlcnkoJ3VzZXIvcG9zdF9jb21tZW50Lz9wb3N0X2lkPScgKyBwcm9kdWN0SWQgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnJmNvb2tpZT0nICsgY29va2llICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyZjb21tZW50X3N0YXR1cz0xJyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICcmY29udGVudD0nICsgY29udGVudClcbiAgICB9XG5cbiAgICBnZXRQcm9kdWN0c0J5U2VhcmNoKHNlYXJjaCwgcGFnZSk6IFEuSVByb21pc2U8e30+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZGIucXVlcnkoJ2NvcmUvZ2V0X3NlYXJjaF9yZXN1bHRzLz9jb3VudD00JnNlYXJjaD0nICsgc2VhcmNoICtcbiAgICAgICAgICAgICcmcGFnZT0nICsgcGFnZSlcbiAgICB9XG5cbn07XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=