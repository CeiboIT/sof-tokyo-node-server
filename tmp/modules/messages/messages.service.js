/// <reference path="../../../typings/tsd.d.ts" />
/// <reference path="../connection/connection.service.ts" />
var Q = require("q");
var connection = require('../connection/connection.service');
var MessagesService = (function () {
    function MessagesService() {
        this.db = connection.service;
    }
    MessagesService.prototype.createMessage = function (sender_id, receiver_id, subject, message) {
        var _this = this;
        var _promise = Q.defer();
        var thread_id = Math.floor((Math.random() * 100000) + 1);
        var now = new Date();
        // insert record sender
        this.db.query_db("INSERT INTO wp2_bp_messages_recipients (id, user_id, thread_id, unread_count, sender_only, is_deleted) " + "VALUES (NULL," + sender_id + "," + thread_id + ",0,0,0)").then(function () {
            // insert record receiver
            _this.db.query_db("INSERT INTO wp2_bp_messages_recipients (id, user_id, thread_id, unread_count, sender_only, is_deleted) " + "VALUES (NULL," + receiver_id + "," + thread_id + ",1,0,0)").then(function () {
                // insert message
                _this.db.query_db("INSERT INTO wp2_bp_messages_messages (id, thread_id, sender_id, subject, message, date_sent) " + "VALUES (NULL," + thread_id + "," + sender_id + ",'" + subject + "','" + message + "','" + now.toISOString() + "')").then(function () {
                    var response = {
                        status: 'Message created OK',
                        thread_id: thread_id,
                        sender_id: sender_id,
                        receiver_id: receiver_id,
                        subject: subject,
                        message: message,
                        date_sent: now.toISOString()
                    };
                    _promise.resolve(response);
                });
            });
        });
        return _promise.promise;
    };
    MessagesService.prototype.responseMessage = function (thread_id, sender_id, receiver_id, subject, message) {
        var _this = this;
        var _promise = Q.defer();
        var resSubject = 'Re: ' + subject;
        var now = new Date();
        // update record sender
        this.db.query_db("UPDATE wp2_bp_messages_recipients SET unread_count = 0 " + "WHERE user_id = " + sender_id + " AND thread_id = " + thread_id).then(function () {
            // update record receiver
            _this.db.query_db("UPDATE wp2_bp_messages_recipients SET unread_count = unread_count+1 WHERE " + " user_id = " + receiver_id + " AND thread_id = " + thread_id).then(function () {
                // insert message
                _this.db.query_db("INSERT INTO wp2_bp_messages_messages (id, thread_id, sender_id, subject, message, date_sent) " + "VALUES (NULL," + thread_id + "," + sender_id + ",'" + resSubject + "','" + message + "','" + now.toISOString() + "')").then(function () {
                    var response = {
                        status: 'Message response OK',
                        thread_id: thread_id,
                        sender_id: sender_id,
                        receiver_id: receiver_id,
                        subject: subject,
                        message: message,
                        date_sent: now.toISOString()
                    };
                    _promise.resolve(response);
                });
            });
        });
        return _promise.promise;
    };
    MessagesService.prototype.showMessages = function (userId) {
        var _this = this;
        var _promise = Q.defer();
        this.db.query_db("SELECT thread_id FROM wp2_bp_messages_recipients WHERE user_id = " + userId).then(function (response) {
            var _threadsPopulate = [];
            var threads = JSON.parse(JSON.stringify(response));
            threads.forEach(function (thread) {
                var threadPromise = Q.defer();
                _threadsPopulate.push(threadPromise.promise);
                var query = "SELECT display_name, sender_id, subject, message FROM wp2_bp_messages_messages " + "INNER JOIN wp2_users " + "ON wp2_bp_messages_messages.sender_id = wp2_users.ID " + "WHERE thread_id = " + thread.thread_id;
                _this.db.query_db(query).then(function (response2) {
                    thread.messages = response2;
                    threadPromise.resolve(response2);
                });
            });
            Q.all(_threadsPopulate).then(function (values) {
                _promise.resolve(threads);
            });
        });
        return _promise.promise;
    };
    return MessagesService;
})();
exports.MessagesService = MessagesService;
;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZHVsZXMvbWVzc2FnZXMvbWVzc2FnZXMuc2VydmljZS50cyJdLCJuYW1lcyI6WyJNZXNzYWdlc1NlcnZpY2UiLCJNZXNzYWdlc1NlcnZpY2UuY29uc3RydWN0b3IiLCJNZXNzYWdlc1NlcnZpY2UuY3JlYXRlTWVzc2FnZSIsIk1lc3NhZ2VzU2VydmljZS5yZXNwb25zZU1lc3NhZ2UiLCJNZXNzYWdlc1NlcnZpY2Uuc2hvd01lc3NhZ2VzIl0sIm1hcHBpbmdzIjoiQUFBQSxrREFBa0Q7QUFDbEQsNERBQTREO0FBRTVELElBQU8sQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDO0FBQ3hCLElBQU8sVUFBVSxXQUFXLGtDQUFrQyxDQUFDLENBQUE7QUFXL0QsSUFBYSxlQUFlO0lBQTVCQSxTQUFhQSxlQUFlQTtRQUNoQkMsT0FBRUEsR0FBR0EsVUFBVUEsQ0FBQ0EsT0FBT0EsQ0FBQ0E7SUFrSHBDQSxDQUFDQTtJQWhIR0QsdUNBQWFBLEdBQWJBLFVBQWNBLFNBQVNBLEVBQUVBLFdBQVdBLEVBQUVBLE9BQU9BLEVBQUVBLE9BQU9BO1FBQXRERSxpQkFrQ0NBO1FBakNHQSxJQUFJQSxRQUFRQSxHQUFHQSxDQUFDQSxDQUFDQSxLQUFLQSxFQUFFQSxDQUFDQTtRQUN6QkEsSUFBSUEsU0FBU0EsR0FBR0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsRUFBRUEsR0FBR0EsTUFBTUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDekRBLElBQUlBLEdBQUdBLEdBQUdBLElBQUlBLElBQUlBLEVBQUVBLENBQUNBO1FBQ3JCQSxBQUNBQSx1QkFEdUJBO1FBQ3ZCQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxRQUFRQSxDQUFDQSx5R0FBeUdBLEdBQ3RHQSxlQUFlQSxHQUFHQSxTQUFTQSxHQUFHQSxHQUFHQSxHQUFHQSxTQUFTQSxHQUFHQSxTQUFTQSxDQUFDQSxDQUN6RUEsSUFBSUEsQ0FBQ0E7WUFFRkEsQUFDQUEs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LENBQUNBLFVBQUNBLFNBQVNBO29CQUNaQSxNQUFNQSxDQUFDQSxRQUFRQSxHQUFHQSxTQUFTQSxDQUFDQTtvQkFDNUJBLGFBQWFBLENBQUNBLE9BQU9BLENBQUNBLFNBQVNBLENBQUNBLENBQUNBO2dCQUNyQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQUE7WUFDVkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFFSEEsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxDQUNsQkEsSUFBSUEsQ0FBQ0EsVUFBQ0EsTUFBTUE7Z0JBQ1RBLFFBQVFBLENBQUNBLE9BQU9BLENBQUNBLE9BQU9BLENBQUNBLENBQUNBO1lBQzlCQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUVYQSxDQUFDQSxDQUFDQSxDQUFBQTtRQUNOQSxNQUFNQSxDQUFDQSxRQUFRQSxDQUFDQSxPQUFPQSxDQUFDQTtJQUM1QkEsQ0FBQ0E7SUFVTEosc0JBQUNBO0FBQURBLENBbkhBLEFBbUhDQSxJQUFBO0FBbkhZLHVCQUFlLEdBQWYsZUFtSFosQ0FBQTtBQUFBLENBQUMiLCJmaWxlIjoibW9kdWxlcy9tZXNzYWdlcy9tZXNzYWdlcy5zZXJ2aWNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8vIDxyZWZlcmVuY2UgcGF0aD1cIi4uLy4uLy4uL3R5cGluZ3MvdHNkLmQudHNcIiAvPlxuLy8vIDxyZWZlcmVuY2UgcGF0aD1cIi4uL2Nvbm5lY3Rpb24vY29ubmVjdGlvbi5zZXJ2aWNlLnRzXCIgLz5cblxuaW1wb3J0IFEgPSByZXF1aXJlKFwicVwiKTtcbmltcG9ydCBjb25uZWN0aW9uID0gcmVxdWlyZSgnLi4vY29ubmVjdGlvbi9jb25uZWN0aW9uLnNlcnZpY2UnKVxuXG5leHBvcnQgaW50ZXJmYWNlIElNZXNzYWdlc1NlcnZpY2Uge1xuICAgIC8vIEdFVFxuICAgIHNob3dNZXNzYWdlcyh1c2VySWQpOiBRLklQcm9taXNlPHt9Pjtcbi8vICAgIHJlYWRNZXNzYWdlcyh1c2VySWQsIHRocmVhZElkKTogUS5JUHJvbWlzZTx7fT47XG4gICAgLy8gUE9TVFxuICAgIGNyZWF0ZU1lc3NhZ2Uoc2VuZGVyX2lkLCByZWNlaXZlcl9pZCwgc3ViamVjdCwgbWVzc2FnZSk6IFEuSVByb21pc2U8e30+O1xuICAgIHJlc3BvbnNlTWVzc2FnZSh0aHJlYWRfaWQsIHNlbmRlcl9pZCwgcmVjZWl2ZXJfaWQsIHN1YmplY3QsIG1lc3NhZ2UpOiBRLklQcm9taXNlPHt9Pjtcbn1cblxuZXhwb3J0IGNsYXNzIE1lc3NhZ2VzU2VydmljZSBpbXBsZW1lbnRzIElNZXNzYWdlc1NlcnZpY2Uge1xuICAgIHByaXZhdGUgZGIgPSBjb25uZWN0aW9uLnNlcnZpY2U7XG5cbiAgICBjcmVhdGVNZXNzYWdlKHNlbmRlcl9pZCwgcmVjZWl2ZXJfaWQsIHN1YmplY3QsIG1lc3NhZ2UpOiBRLklQcm9taXNlPHt9PiB7XG4gICAgICAgIHZhciBfcHJvbWlzZSA9IFEuZGVmZXIoKTtcbiAgICAgICAgdmFyIHRocmVhZF9pZCA9IE1hdGguZmxvb3IoKE1hdGgucmFuZG9tKCkgKiAxMDAwMDApICsgMSk7XG4gICAgICAgIHZhciBub3cgPSBuZXcgRGF0ZSgpO1xuICAgICAgICAvLyBpbnNlcnQgcmVjb3JkIHNlbmRlclxuICAgICAgICB0aGlzLmRiLnF1ZXJ5X2RiKFwiSU5TRVJUIElOVE8gd3AyX2JwX21lc3NhZ2VzX3JlY2lwaWVudHMgKGlkLCB1c2VyX2lkLCB0aHJlYWRfaWQsIHVucmVhZF9jb3VudCwgc2VuZGVyX29ubHksIGlzX2RlbGV0ZWQpIFwiICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIlZBTFVFUyAoTlVMTCxcIiArIHNlbmRlcl9pZCArIFwiLFwiICsgdGhyZWFkX2lkICsgXCIsMCwwLDApXCIpXG4gICAgICAgICAgICAudGhlbigoKSA9PiB7XG5cbiAgICAgICAgICAgICAgICAvLyBpbnNlcnQgcmVjb3JkIHJlY2VpdmVyXG4gICAgICAgICAgICAgICAgdGhpcy5kYi5xdWVyeV9kYihcIklOU0VSVCBJTlRPIHdwMl9icF9tZXNzYWdlc19yZWNpcGllbnRzIChpZCwgdXNlcl9pZCwgdGhyZWFkX2lkLCB1bnJlYWRfY291bnQsIHNlbmRlcl9vbmx5LCBpc19kZWxldGVkKSBcIiArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIlZBTFVFUyAoTlVMTCxcIiArIHJlY2VpdmVyX2lkICsgXCIsXCIgKyB0aHJlYWRfaWQgKyBcIiwxLDAsMClcIilcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBpbnNlcnQgbWVzc2FnZVxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kYi5xdWVyeV9kYihcIklOU0VSVCBJTlRPIHdwMl9icF9tZXNzYWdlc19tZXNzYWdlcyAoaWQsIHRocmVhZF9pZCwgc2VuZGVyX2lkLCBzdWJqZWN0LCBtZXNzYWdlLCBkYXRlX3NlbnQpIFwiICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJWQUxVRVMgKE5VTEwsXCIgKyB0aHJlYWRfaWQgKyBcIixcIiArIHNlbmRlcl9pZCArIFwiLCdcIiArIHN1YmplY3QgKyBcIicsJ1wiICsgbWVzc2FnZSArIFwiJywnXCIgKyBub3cudG9JU09TdHJpbmcoKSArIFwiJylcIilcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXNwb25zZSA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1czogJ01lc3NhZ2UgY3JlYXRlZCBPSycsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJlYWRfaWQ6IHRocmVhZF9pZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRlcl9pZDogc2VuZGVyX2lkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjZWl2ZXJfaWQ6IHJlY2VpdmVyX2lkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ViamVjdDogc3ViamVjdCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRlX3NlbnQ6IG5vdy50b0lTT1N0cmluZygpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9wcm9taXNlLnJlc29sdmUocmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgfSlcbiAgICAgICAgcmV0dXJuIF9wcm9taXNlLnByb21pc2U7XG4gICAgfVxuXG4gICAgcmVzcG9uc2VNZXNzYWdlKHRocmVhZF9pZCwgc2VuZGVyX2lkLCByZWNlaXZlcl9pZCwgc3ViamVjdCwgbWVzc2FnZSk6IFEuSVByb21pc2U8e30+IHtcbiAgICAgICAgdmFyIF9wcm9taXNlID0gUS5kZWZlcigpO1xuICAgICAgICB2YXIgcmVzU3ViamVjdCA9ICdSZTogJyArIHN1YmplY3Q7XG4gICAgICAgIHZhciBub3cgPSBuZXcgRGF0ZSgpO1xuICAgICAgICAvLyB1cGRhdGUgcmVjb3JkIHNlbmRlclxuICAgICAgICB0aGlzLmRiLnF1ZXJ5X2RiKFwiVVBEQVRFIHdwMl9icF9tZXNzYWdlc19yZWNpcGllbnRzIFNFVCB1bnJlYWRfY291bnQgPSAwIFwiICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIldIRVJFIHVzZXJfaWQgPSBcIiArIHNlbmRlcl9pZCArIFwiIEFORCB0aHJlYWRfaWQgPSBcIiArIHRocmVhZF9pZClcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHtcblxuICAgICAgICAgICAgICAgIC8vIHVwZGF0ZSByZWNvcmQgcmVjZWl2ZXJcbiAgICAgICAgICAgICAgICB0aGlzLmRiLnF1ZXJ5X2RiKFwiVVBEQVRFIHdwMl9icF9tZXNzYWdlc19yZWNpcGllbnRzIFNFVCB1bnJlYWRfY291bnQgPSB1bnJlYWRfY291bnQrMSBXSEVSRSBcIiArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiIHVzZXJfaWQgPSBcIiArIHJlY2VpdmVyX2lkICsgXCIgQU5EIHRocmVhZF9pZCA9IFwiICsgdGhyZWFkX2lkKVxuICAgICAgICAgICAgICAgICAgICAudGhlbigoKSA9PiB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGluc2VydCBtZXNzYWdlXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRiLnF1ZXJ5X2RiKFwiSU5TRVJUIElOVE8gd3AyX2JwX21lc3NhZ2VzX21lc3NhZ2VzIChpZCwgdGhyZWFkX2lkLCBzZW5kZXJfaWQsIHN1YmplY3QsIG1lc3NhZ2UsIGRhdGVfc2VudCkgXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIlZBTFVFUyAoTlVMTCxcIiArIHRocmVhZF9pZCArIFwiLFwiICsgc2VuZGVyX2lkICsgXCIsJ1wiICsgcmVzU3ViamVjdCArIFwiJywnXCIgKyBtZXNzYWdlICsgXCInLCdcIiArIG5vdy50b0lTT1N0cmluZygpICsgXCInKVwiKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3BvbnNlID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiAnTWVzc2FnZSByZXNwb25zZSBPSycsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJlYWRfaWQ6IHRocmVhZF9pZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRlcl9pZDogc2VuZGVyX2lkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjZWl2ZXJfaWQ6IHJlY2VpdmVyX2lkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ViamVjdDogc3ViamVjdCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRlX3NlbnQ6IG5vdy50b0lTT1N0cmluZygpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9wcm9taXNlLnJlc29sdmUocmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgfSlcbiAgICAgICAgcmV0dXJuIF9wcm9taXNlLnByb21pc2U7XG4gICAgfVxuXG4gICAgc2hvd01lc3NhZ2VzKHVzZXJJZCk6IFEuSVByb21pc2U8e30+IHtcbiAgICAgICAgdmFyIF9wcm9taXNlID0gUS5kZWZlcigpO1xuXG4gICAgICAgIHRoaXMuZGIucXVlcnlfZGIoXCJTRUxFQ1QgdGhyZWFkX2lkIEZST00gd3AyX2JwX21lc3NhZ2VzX3JlY2lwaWVudHMgV0hFUkUgdXNlcl9pZCA9IFwiICsgdXNlcklkKVxuICAgICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICAgICAgdmFyIF90aHJlYWRzUG9wdWxhdGUgPSBbXTtcbiAgICAgICAgICAgICAgICB2YXIgdGhyZWFkcyA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkocmVzcG9uc2UpKTtcblxuICAgICAgICAgICAgICAgIHRocmVhZHMuZm9yRWFjaCgodGhyZWFkKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHZhciB0aHJlYWRQcm9taXNlID0gUS5kZWZlcigpO1xuICAgICAgICAgICAgICAgICAgICBfdGhyZWFkc1BvcHVsYXRlLnB1c2godGhyZWFkUHJvbWlzZS5wcm9taXNlKTtcblxuICAgICAgICAgICAgICAgICAgICB2YXIgcXVlcnkgPSBcIlNFTEVDVCBkaXNwbGF5X25hbWUsIHNlbmRlcl9pZCwgc3ViamVjdCwgbWVzc2FnZSBGUk9NIHdwMl9icF9tZXNzYWdlc19tZXNzYWdlcyBcIiArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiSU5ORVIgSk9JTiB3cDJfdXNlcnMgXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIk9OIHdwMl9icF9tZXNzYWdlc19tZXNzYWdlcy5zZW5kZXJfaWQgPSB3cDJfdXNlcnMuSUQgXCIgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcIldIRVJFIHRocmVhZF9pZCA9IFwiICsgdGhyZWFkLnRocmVhZF9pZDtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kYi5xdWVyeV9kYihxdWVyeSlcbiAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKChyZXNwb25zZTIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJlYWQubWVzc2FnZXMgPSByZXNwb25zZTI7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyZWFkUHJvbWlzZS5yZXNvbHZlKHJlc3BvbnNlMik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgUS5hbGwoX3RocmVhZHNQb3B1bGF0ZSlcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oKHZhbHVlcykgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgX3Byb21pc2UucmVzb2x2ZSh0aHJlYWRzKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIH0pXG4gICAgICAgIHJldHVybiBfcHJvbWlzZS5wcm9taXNlO1xuICAgIH1cblxuLypcbiAgICByZWFkTWVzc2FnZXModXNlcklkLCB0aHJlYWRJZCk6IFEuSVByb21pc2U8e30+IHtcbiAgICAgICAgdmFyIF9wcm9taXNlID0gUS5kZWZlcigpO1xuXG4gICAgICAgIC8vIHVucmVhZCA9IDA7XG4gICAgfVxuKi9cblxufTtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==